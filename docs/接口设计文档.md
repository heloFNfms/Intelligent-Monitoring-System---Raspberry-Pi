# 智能生产线监控系统 - 接口设计文档

## 1. 概述

本文档描述系统的所有API接口，包括HTTP REST API和WebSocket接口。

- **后端地址**: `http://localhost:8000`
- **API文档**: `http://localhost:8000/docs` (Swagger UI)
- **WebSocket**: `ws://localhost:8000/ws/...`

## 2. HTTP REST API

### 2.1 检测数据接口

#### 上报检测数据
```
POST /api/detection
```

**请求体**:
```json
{
  "device_id": "device_001",
  "person_count": 2,
  "in_danger_zone": true,
  "alert_triggered": true,
  "details": "可选的详细信息"
}
```

**响应**:
```json
{
  "id": 1,
  "device_id": "device_001",
  "timestamp": "2024-12-11T15:30:00",
  "person_count": 2,
  "in_danger_zone": true,
  "alert_triggered": true
}
```

#### 获取检测历史
```
GET /api/detection/history?device_id=device_001&limit=100
```

---

### 2.2 传感器数据接口

#### 上报传感器数据
```
POST /api/sensor
```

**请求体**:
```json
{
  "device_id": "device_001",
  "sensor_type": "temperature",
  "value": 65.5,
  "unit": "°C"
}
```

**sensor_type可选值**: `temperature`, `pressure`, `humidity`

#### 获取最新传感器数据
```
GET /api/sensor/latest?device_id=device_001
```

**响应**:
```json
{
  "temperature": { "value": 65.5, "unit": "°C", "timestamp": "..." },
  "pressure": { "value": 101.3, "unit": "kPa", "timestamp": "..." },
  "humidity": { "value": 55.0, "unit": "%", "timestamp": "..." }
}
```

#### 获取传感器历史数据
```
GET /api/sensor/history?device_id=device_001&sensor_type=temperature&hours=24
```

---

### 2.3 生产状态接口

#### 获取生产状态
```
GET /api/status/{device_id}
```

**响应**:
```json
{
  "device_id": "device_001",
  "status": "running",
  "mode": "product_a",
  "production_count": 150,
  "updated_at": "2024-12-11T15:30:00"
}
```

**status可选值**: `running`, `stopped`, `paused`
**mode可选值**: `product_a`, `product_b`

#### 更新生产状态
```
PUT /api/status/{device_id}
```

**请求体**:
```json
{
  "status": "running",
  "mode": "product_b",
  "production_count": 200
}
```

---

### 2.4 控制指令接口

#### 发送控制指令
```
POST /api/control
```

**请求体**:
```json
{
  "device_id": "device_001",
  "command": "start",
  "params": {}
}
```

**command可选值**:
- `start` - 启动生产线
- `stop` - 停止生产线
- `pause` - 暂停生产线
- `switch_mode` - 切换模式，需要params: `{"mode": "product_b"}`
- `reset_count` - 重置生产计数

**响应**:
```json
{
  "success": true,
  "message": "生产线已启动",
  "command": "start"
}
```

---

### 2.5 报警接口

#### 获取报警列表
```
GET /api/alerts?resolved=false&limit=50
```

**响应**:
```json
[
  {
    "id": 1,
    "device_id": "device_001",
    "alert_type": "intrusion",
    "timestamp": "2024-12-11T15:30:00",
    "message": "检测到人员进入危险区域",
    "level": "danger",
    "resolved": false
  }
]
```

**alert_type可选值**: `intrusion`, `temperature`, `pressure`
**level可选值**: `info`, `warning`, `danger`

#### 处理报警
```
PUT /api/alerts/{alert_id}/resolve
```

---

### 2.6 仪表盘接口

#### 获取仪表盘汇总数据
```
GET /api/dashboard?device_id=device_001
```

**响应**:
```json
{
  "production_status": "running",
  "production_mode": "product_a",
  "total_production": 150,
  "current_temperature": 65.5,
  "current_pressure": 101.3,
  "active_alerts": 2,
  "today_alerts": 5,
  "today_detections": 100,
  "danger_zone_entries": 3
}
```

---

## 3. WebSocket接口

### 3.1 前端大屏连接
```
ws://localhost:8000/ws/dashboard
```

**接收消息类型**:

#### 传感器数据更新
```json
{
  "type": "sensor_update",
  "data": {
    "device_id": "device_001",
    "sensor_type": "temperature",
    "value": 65.5,
    "unit": "°C"
  },
  "timestamp": "2024-12-11T15:30:00"
}
```

#### 检测结果
```json
{
  "type": "detection",
  "data": {
    "device_id": "device_001",
    "person_count": 2,
    "in_danger_zone": true,
    "alert_triggered": true
  },
  "timestamp": "2024-12-11T15:30:00"
}
```

#### 报警信息
```json
{
  "type": "alert",
  "data": {
    "device_id": "device_001",
    "alert_type": "intrusion",
    "message": "检测到人员进入危险区域！",
    "level": "danger"
  },
  "timestamp": "2024-12-11T15:30:00"
}
```

#### 状态变化
```json
{
  "type": "status_change",
  "data": {
    "device_id": "device_001",
    "status": "running",
    "mode": "product_a",
    "production_count": 150
  },
  "timestamp": "2024-12-11T15:30:00"
}
```

**发送消息（控制指令）**:
```json
{
  "type": "control",
  "data": {
    "device_id": "device_001",
    "command": "start",
    "params": {}
  }
}
```

### 3.2 设备连接
```
ws://localhost:8000/ws/device/{device_id}
```

**接收消息（控制指令）**:
```json
{
  "type": "control",
  "command": "start",
  "params": {}
}
```

**发送消息（数据上报）**:
```json
{
  "type": "sensor",
  "data": {
    "sensor_type": "temperature",
    "value": 65.5,
    "unit": "°C"
  }
}
```

---

## 4. 错误响应

所有接口在发生错误时返回统一格式：

```json
{
  "detail": "错误描述信息"
}
```

**HTTP状态码**:
- `200` - 成功
- `400` - 请求参数错误
- `404` - 资源不存在
- `500` - 服务器内部错误
