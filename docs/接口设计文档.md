# 智能生产线监控系统 - 接口设计文档

> 版本：v2.0  
> 更新日期：2024年12月  
> 基础URL：`http://{host}:8000`  
> API文档：`http://{host}:8000/docs` (Swagger UI)

---

## 1. 接口概述

### 1.1 接口分类

| 分类 | 前缀 | 说明 |
|------|------|------|
| 传感器数据 | `/api/sensor` | 传感器数据上报与查询 |
| 检测数据 | `/api/detection` | 人员检测数据上报与查询 |
| 生产状态 | `/api/status` | 生产状态查询与更新 |
| 控制指令 | `/api/control` | 生产线远程控制 |
| 报警管理 | `/api/alerts` | 报警记录查询与处理 |
| 仪表盘 | `/api/dashboard` | 汇总数据查询 |
| 传送带 | `/api/conveyor` | 传送带状态与控制 |
| 调度管理 | `/api/scheduler` | 自动调度规则管理 |
| 危险区域 | `/api/zone` | 危险区域统计与事件 |
| 视频流 | `/api/video` | 视频帧上报与获取 |
| 产品检测 | `/api/product` | 产品检测结果上报 |
| LED控制 | `/api/led` | LED状态上报 |
| 检测模式 | `/api/detection/mode` | 检测模式切换 |
| 数据管理 | `/api/data` | 数据统计与清理 |
| WebSocket | `/ws` | 实时通信 |

### 1.2 通用响应格式

**成功响应**：
```json
{
  "success": true,
  "message": "操作成功",
  "data": { ... }
}
```

**错误响应**：
```json
{
  "detail": "错误描述"
}
```

### 1.3 HTTP状态码

| 状态码 | 说明 |
|--------|------|
| 200 | 请求成功 |
| 400 | 请求参数错误 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |


---

## 2. 传感器数据接口

### 2.1 上报传感器数据

**POST** `/api/sensor`

上报设备传感器数据（温度、压力、湿度）。

**请求体**：
```json
{
  "device_id": "device_001",
  "sensor_type": "temperature",
  "value": 65.5,
  "unit": "°C"
}
```

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| device_id | string | 是 | 设备ID |
| sensor_type | string | 是 | 传感器类型：`temperature`/`pressure`/`humidity` |
| value | float | 是 | 传感器值 |
| unit | string | 否 | 单位 |

**响应**：
```json
{
  "id": 1,
  "device_id": "device_001",
  "sensor_type": "temperature",
  "timestamp": "2024-12-14T10:30:00",
  "value": 65.5,
  "unit": "°C"
}
```

**触发逻辑**：
- 温度 ≥ 95°C：触发危险报警，记录报警，广播通知
- 温度 ≥ 80°C：触发警告通知
- 自动调度：检查温度调度规则

---

### 2.2 获取最新传感器数据

**GET** `/api/sensor/latest`

获取设备各类型传感器的最新值。

**查询参数**：
| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| device_id | string | 否 | device_001 | 设备ID |

**响应**：
```json
{
  "temperature": {
    "value": 65.5,
    "unit": "°C",
    "timestamp": "2024-12-14T10:30:00"
  },
  "pressure": {
    "value": 101.3,
    "unit": "kPa",
    "timestamp": "2024-12-14T10:30:00"
  },
  "humidity": {
    "value": 55.0,
    "unit": "%",
    "timestamp": "2024-12-14T10:30:00"
  }
}
```

---

### 2.3 获取传感器历史数据

**GET** `/api/sensor/history`

获取传感器历史数据，用于绘制趋势图。

**查询参数**：
| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| device_id | string | 否 | - | 设备ID |
| sensor_type | string | 否 | - | 传感器类型 |
| hours | int | 否 | 24 | 查询最近N小时 |

**响应**：
```json
[
  {
    "id": 1,
    "device_id": "device_001",
    "sensor_type": "temperature",
    "timestamp": "2024-12-14T10:30:00",
    "value": 65.5,
    "unit": "°C"
  }
]
```

---

## 3. 检测数据接口

### 3.1 上报检测结果

**POST** `/api/detection`

上报人员检测结果。

**请求体**：
```json
{
  "device_id": "device_001",
  "person_count": 1,
  "in_danger_zone": true,
  "alert_triggered": true,
  "details": "{\"bboxes\": [[100, 200, 300, 400]]}"
}
```

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| device_id | string | 是 | 设备ID |
| person_count | int | 否 | 检测到的人数，默认0 |
| in_danger_zone | bool | 否 | 是否在危险区域，默认false |
| alert_triggered | bool | 否 | 是否触发报警，默认false |
| details | string | 否 | 详细信息JSON |

**响应**：
```json
{
  "id": 1,
  "device_id": "device_001",
  "timestamp": "2024-12-14T10:30:00",
  "person_count": 1,
  "in_danger_zone": true,
  "alert_triggered": true
}
```

**触发逻辑**：
- 若 `alert_triggered=true`：记录入侵报警，广播报警通知

---

### 3.2 获取检测历史

**GET** `/api/detection/history`

**查询参数**：
| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| device_id | string | 否 | - | 设备ID |
| limit | int | 否 | 100 | 返回记录数 |

**响应**：
```json
[
  {
    "id": 1,
    "device_id": "device_001",
    "timestamp": "2024-12-14T10:30:00",
    "person_count": 1,
    "in_danger_zone": true,
    "alert_triggered": true
  }
]
```

---

### 3.3 获取检测模式

**GET** `/api/detection/mode/{device_id}`

**响应**：
```json
{
  "device_id": "device_001",
  "mode": "zone"
}
```

| mode值 | 说明 |
|--------|------|
| zone | 危险区域检测模式 |
| product | 产品检测模式 |

---

### 3.4 设置检测模式

**PUT** `/api/detection/mode/{device_id}`

**请求体**：
```json
{
  "mode": "product"
}
```

**响应**：
```json
{
  "success": true,
  "device_id": "device_001",
  "mode": "product"
}
```


---

## 4. 生产状态接口

### 4.1 获取生产状态

**GET** `/api/status/{device_id}`

**路径参数**：
| 参数 | 类型 | 说明 |
|------|------|------|
| device_id | string | 设备ID |

**响应**：
```json
{
  "device_id": "device_001",
  "status": "running",
  "mode": "product_a",
  "production_count": 150,
  "updated_at": "2024-12-14T10:30:00"
}
```

| 字段 | 说明 |
|------|------|
| status | 状态：`running`/`stopped`/`paused` |
| mode | 生产模式：`product_a`/`product_b` |
| production_count | 累计生产数量 |

---

### 4.2 更新生产状态

**PUT** `/api/status/{device_id}`

**请求体**：
```json
{
  "status": "running",
  "mode": "product_b",
  "production_count": 200
}
```

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| status | string | 否 | 状态 |
| mode | string | 否 | 生产模式 |
| production_count | int | 否 | 生产计数 |

**响应**：同获取生产状态

---

## 5. 控制指令接口

### 5.1 发送控制指令

**POST** `/api/control`

发送生产线控制指令。

**请求体**：
```json
{
  "device_id": "device_001",
  "command": "start",
  "params": {}
}
```

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| device_id | string | 是 | 设备ID |
| command | string | 是 | 控制指令 |
| params | object | 否 | 指令参数 |

**支持的指令**：

| command | params | 说明 |
|---------|--------|------|
| start | - | 启动生产线 |
| stop | - | 停止生产线 |
| pause | - | 暂停生产线 |
| switch_mode | `{"mode": "product_b"}` | 切换生产模式 |
| reset_count | - | 重置生产计数 |

**响应**：
```json
{
  "success": true,
  "message": "生产线已启动",
  "command": "start"
}
```

**触发逻辑**：
1. 更新数据库生产状态
2. 同步传送带管理器状态
3. 广播状态变更到前端
4. 尝试推送指令到设备端

---

## 6. 报警管理接口

### 6.1 获取报警列表

**GET** `/api/alerts`

**查询参数**：
| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| device_id | string | 否 | - | 设备ID |
| resolved | bool | 否 | - | 是否已处理 |
| limit | int | 否 | 50 | 返回记录数 |

**响应**：
```json
[
  {
    "id": 1,
    "device_id": "device_001",
    "alert_type": "intrusion",
    "timestamp": "2024-12-14T10:30:00",
    "message": "检测到人员进入危险区域",
    "level": "danger",
    "resolved": false
  }
]
```

**报警类型**：

| alert_type | 说明 |
|------------|------|
| intrusion | 人员入侵 |
| temperature | 温度异常 |
| pressure | 压力异常 |
| zone_enter | 进入危险区 |
| zone_exit | 离开危险区 |

**报警级别**：

| level | 说明 |
|-------|------|
| info | 信息 |
| warning | 警告 |
| danger | 危险 |

---

### 6.2 处理报警

**PUT** `/api/alerts/{alert_id}/resolve`

**路径参数**：
| 参数 | 类型 | 说明 |
|------|------|------|
| alert_id | int | 报警记录ID |

**响应**：
```json
{
  "id": 1,
  "device_id": "device_001",
  "alert_type": "intrusion",
  "timestamp": "2024-12-14T10:30:00",
  "message": "检测到人员进入危险区域",
  "level": "danger",
  "resolved": true
}
```

---

## 7. 仪表盘接口

### 7.1 获取仪表盘数据

**GET** `/api/dashboard`

获取仪表盘汇总数据。

**查询参数**：
| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| device_id | string | 否 | device_001 | 设备ID |

**响应**：
```json
{
  "production_status": "running",
  "production_mode": "product_a",
  "total_production": 150,
  "current_temperature": 65.5,
  "current_pressure": 101.3,
  "active_alerts": 2,
  "today_alerts": 5,
  "today_detections": 100,
  "danger_zone_entries": 3
}
```

| 字段 | 说明 |
|------|------|
| production_status | 当前生产状态 |
| production_mode | 当前生产模式 |
| total_production | 累计生产数量 |
| current_temperature | 当前温度 |
| current_pressure | 当前压力 |
| active_alerts | 未处理报警数 |
| today_alerts | 今日报警数 |
| today_detections | 今日检测次数 |
| danger_zone_entries | 今日危险区入侵次数 |


---

## 8. 传送带接口

### 8.1 获取传送带状态

**GET** `/api/conveyor/{device_id}`

**响应**：
```json
{
  "is_running": true,
  "speed": 1.0,
  "product_mode": "product_a",
  "items": [
    {
      "id": 1,
      "position": 45.5,
      "type": "product_a",
      "color": "#3a91c7",
      "shape": "box",
      "created_at": 1702540200.123
    }
  ],
  "completed_count": 50,
  "auto_generate": true
}
```

| 字段 | 说明 |
|------|------|
| is_running | 是否运行中 |
| speed | 速度倍率 (0.5-2.0) |
| product_mode | 产品模式 |
| items | 传送带上的物品列表 |
| completed_count | 已完成数量 |
| auto_generate | 是否自动生成物品 |

---

### 8.2 传送带控制

**POST** `/api/conveyor/{device_id}/control`

**请求体**：
```json
{
  "command": "set_speed",
  "params": {
    "speed": 1.5
  }
}
```

**支持的指令**：

| command | params | 说明 |
|---------|--------|------|
| start | - | 启动传送带 |
| stop | - | 停止传送带 |
| pause | - | 暂停传送带 |
| add_item | - | 手动添加物品 |
| clear | - | 清空所有物品 |
| set_speed | `{"speed": 1.5}` | 设置速度 (0.5-2.0) |
| reset | - | 重置传送带 |

**响应**：
```json
{
  "success": true,
  "command": "set_speed",
  "message": "速度已设置为 1.5x"
}
```

---

## 9. 调度管理接口

### 9.1 获取调度器状态

**GET** `/api/scheduler/{device_id}`

**响应**：
```json
{
  "rules": [
    {
      "id": "temp_danger_pause",
      "name": "高温自动暂停",
      "enabled": true,
      "rule_type": "temperature",
      "condition": "gt",
      "threshold": 95.0,
      "action": "pause",
      "action_params": {},
      "cooldown": 30.0
    }
  ],
  "plan": {
    "device_id": "device_001",
    "target_count": 100,
    "start_time": "2024-12-14T10:00:00",
    "end_time": null,
    "auto_stop_on_complete": true,
    "auto_switch_mode": null
  },
  "paused_by_temp": false
}
```

---

### 9.2 获取调度规则列表

**GET** `/api/scheduler/{device_id}/rules`

**响应**：
```json
[
  {
    "id": "temp_danger_pause",
    "name": "高温自动暂停",
    "enabled": true,
    "rule_type": "temperature",
    "condition": "gt",
    "threshold": 95.0,
    "action": "pause",
    "action_params": {},
    "cooldown": 30.0
  },
  {
    "id": "temp_recover_start",
    "name": "温度恢复自动启动",
    "enabled": true,
    "rule_type": "temperature_recover",
    "condition": "lt",
    "threshold": 80.0,
    "action": "start",
    "action_params": {},
    "cooldown": 30.0
  },
  {
    "id": "production_complete",
    "name": "产量达标自动停止",
    "enabled": true,
    "rule_type": "production",
    "condition": "gte",
    "threshold": 100,
    "action": "stop",
    "action_params": {},
    "cooldown": 5.0
  }
]
```

---

### 9.3 更新调度规则

**PUT** `/api/scheduler/{device_id}/rules/{rule_id}`

**请求体**：
```json
{
  "enabled": false,
  "threshold": 90.0,
  "cooldown": 60.0
}
```

| 字段 | 类型 | 说明 |
|------|------|------|
| enabled | bool | 是否启用 |
| threshold | float | 阈值 |
| cooldown | float | 冷却时间(秒) |

**响应**：
```json
{
  "success": true,
  "rule_id": "temp_danger_pause"
}
```

---

### 9.4 设置生产计划

**POST** `/api/scheduler/{device_id}/plan`

**请求体**：
```json
{
  "target_count": 200,
  "auto_stop": true,
  "auto_switch_mode": "product_b"
}
```

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| target_count | int | 是 | 目标产量 (0=无限制) |
| auto_stop | bool | 否 | 达标后自动停止，默认true |
| auto_switch_mode | string | 否 | 达标后切换模式 |

**响应**：
```json
{
  "success": true,
  "plan": {
    "device_id": "device_001",
    "target_count": 200,
    "start_time": "2024-12-14T10:00:00",
    "end_time": null,
    "auto_stop_on_complete": true,
    "auto_switch_mode": "product_b"
  }
}
```

---

### 9.5 清除生产计划

**DELETE** `/api/scheduler/{device_id}/plan`

**响应**：
```json
{
  "success": true
}
```

---

### 9.6 获取生产计划进度

**GET** `/api/scheduler/{device_id}/progress`

**响应**：
```json
{
  "has_plan": true,
  "target": 200,
  "current": 150,
  "progress": 75.0,
  "remaining": 50,
  "estimated_time": "11:30:00"
}
```

| 字段 | 说明 |
|------|------|
| has_plan | 是否有生产计划 |
| target | 目标产量 |
| current | 当前产量 |
| progress | 进度百分比 |
| remaining | 剩余数量 |
| estimated_time | 预计完成时间 |


---

## 10. 危险区域接口

### 10.1 上报危险区域事件

**POST** `/api/zone/event`

上报人员进入/离开危险区域事件，数据持久化到数据库。

**请求体**：
```json
{
  "device_id": "device_001",
  "event_type": "enter",
  "statistics": {
    "total_entries": 10,
    "total_exits": 8,
    "current_in_danger": 2
  },
  "message": "⚠️ 人员进入危险区域！当前危险区人数: 2"
}
```

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| device_id | string | 否 | 设备ID，默认device_001 |
| event_type | string | 是 | 事件类型：`enter`/`exit` |
| statistics | object | 否 | 客户端统计信息 |
| message | string | 否 | 事件消息 |

**响应**：
```json
{
  "success": true,
  "event_type": "enter",
  "statistics": {
    "total_entries": 10,
    "total_exits": 8,
    "current_in_danger": 2,
    "last_entry_time": "2024-12-14T10:30:00",
    "last_exit_time": "2024-12-14T10:25:00"
  }
}
```

**触发逻辑**：
- `enter` 事件：记录 `zone_enter` 报警 (danger级别)，广播报警
- `exit` 事件：记录 `zone_exit` 报警 (info级别)，广播通知
- 更新 `zone_statistics` 表
- 记录到 `zone_event_records` 表
- 广播 `zone_statistics` 消息到前端

---

### 10.2 获取危险区域统计

**GET** `/api/zone/statistics/{device_id}`

**响应**：
```json
{
  "device_id": "device_001",
  "statistics": {
    "total_entries": 10,
    "total_exits": 8,
    "current_in_danger": 2,
    "last_entry_time": "2024-12-14T10:30:00",
    "last_exit_time": "2024-12-14T10:25:00"
  }
}
```

---

### 10.3 重置危险区域统计

**DELETE** `/api/zone/statistics/{device_id}`

**查询参数**：
| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| clear_events | bool | 否 | false | 是否同时清除事件历史记录 |

**响应**：
```json
{
  "success": true,
  "message": "统计信息已重置",
  "statistics": {
    "total_entries": 0,
    "total_exits": 0,
    "current_in_danger": 0,
    "last_entry_time": null,
    "last_exit_time": null
  }
}
```

---

### 10.4 获取危险区域事件历史

**GET** `/api/zone/events/{device_id}`

**查询参数**：
| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| limit | int | 否 | 100 | 返回记录数 |
| hours | int | 否 | - | 只返回最近N小时 |

**响应**：
```json
{
  "device_id": "device_001",
  "count": 5,
  "events": [
    {
      "id": 1,
      "event_type": "enter",
      "timestamp": "2024-12-14T10:30:00",
      "person_count": 1,
      "current_in_danger": 2,
      "message": "人员进入危险区域"
    }
  ]
}
```

---

## 11. 视频流接口

### 11.1 上报视频帧

**POST** `/api/video/frame`

上报视频帧（Base64编码的JPEG图像）。

**请求体**：
```json
{
  "device_id": "device_001",
  "frame": "/9j/4AAQSkZJRgABAQAAAQABAAD...",
  "timestamp": "2024-12-14T10:30:00",
  "detection": {
    "person_count": 1,
    "in_danger_zone": false
  }
}
```

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| device_id | string | 否 | 设备ID |
| frame | string | 是 | Base64编码的JPEG图像 |
| timestamp | string | 否 | 时间戳 |
| detection | object | 否 | 检测信息 |

**响应**：
```json
{
  "success": true
}
```

**触发逻辑**：
- 缓存最新帧
- 广播 `video_frame` 消息到前端

---

### 11.2 获取最新视频帧

**GET** `/api/video/latest/{device_id}`

**响应**：
```json
{
  "frame": "/9j/4AAQSkZJRgABAQAAAQABAAD...",
  "detection": {
    "person_count": 1,
    "in_danger_zone": false
  },
  "timestamp": "2024-12-14T10:30:00"
}
```

---

## 12. 产品检测接口

### 12.1 上报产品检测结果

**POST** `/api/product/detection`

**请求体**：
```json
{
  "device_id": "device_001",
  "product_type": "product_a",
  "color": "蓝色",
  "shape": "方形",
  "confidence": 0.9
}
```

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| device_id | string | 否 | 设备ID |
| product_type | string | 是 | 产品类型：`product_a`/`product_b`/`unknown` |
| color | string | 否 | 颜色 |
| shape | string | 否 | 形状 |
| confidence | float | 否 | 置信度 |

**响应**：
```json
{
  "success": true,
  "product_type": "product_a"
}
```

---

## 13. LED控制接口

### 13.1 上报LED状态

**POST** `/api/led`

**请求体**：
```json
{
  "device_id": "device_001",
  "led_type": "alert",
  "state": true
}
```

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| device_id | string | 否 | 设备ID |
| led_type | string | 是 | LED类型：`alert`/`product_a`/`product_b`/`running` |
| state | bool | 是 | 状态：true=亮，false=灭 |

**响应**：
```json
{
  "success": true,
  "led_type": "alert",
  "state": true
}
```


---

## 14. 数据管理接口

### 14.1 获取数据统计

**GET** `/api/data/statistics`

获取数据库各表的记录数统计。

**响应**：
```json
{
  "sensor_data_count": 10000,
  "detection_count": 500,
  "alert_count": 50,
  "total_records": 10550
}
```

---

### 14.2 清理过期数据

**DELETE** `/api/data/cleanup`

清理过期的历史数据。

**查询参数**：
| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| days_to_keep | int | 否 | 7 | 保留最近N天的数据 |

**响应**：
```json
{
  "success": true,
  "message": "已清理 1000 条过期数据",
  "deleted_count": 1000,
  "days_kept": 7
}
```

---

## 15. 系统接口

### 15.1 健康检查

**GET** `/health`

**响应**：
```json
{
  "status": "ok",
  "timestamp": "2024-12-14T10:30:00"
}
```

---

## 16. WebSocket 接口

### 16.1 前端大屏连接

**WebSocket** `ws://{host}:8000/ws/dashboard`

前端监控大屏的实时数据通道。

**连接后可接收的消息类型**：

| type | 说明 | data 结构 |
|------|------|-----------|
| sensor_update | 传感器更新 | `{device_id, sensor_type, value, unit}` |
| detection | 检测结果 | `{device_id, person_count, in_danger_zone, alert_triggered}` |
| alert | 报警通知 | `{device_id, alert_type, message, level}` |
| status_change | 状态变更 | `{device_id, status, mode, production_count}` |
| conveyor_update | 传送带更新 | `{device_id, is_running, speed, items, completed_count}` |
| zone_event | 危险区域事件 | `{device_id, event_type, statistics, message}` |
| zone_statistics | 区域统计更新 | `{device_id, event_type, statistics, message}` |
| video_frame | 视频帧 | `{device_id, frame, detection}` |
| led_status | LED状态 | `{device_id, led_type, state}` |
| schedule_action | 调度动作 | `{device_id, action, reason, message}` |
| product_detection | 产品检测 | `{device_id, product_type, color, shape, confidence}` |
| detection_mode_change | 检测模式切换 | `{device_id, mode}` |

**可发送的消息**：

```json
{
  "type": "control",
  "data": {
    "device_id": "device_001",
    "command": "start",
    "params": {}
  }
}
```

---

### 16.2 设备端连接

**WebSocket** `ws://{host}:8000/ws/device/{device_id}`

设备端（树莓派）的实时数据通道。

**可发送的消息类型**：

| type | 说明 | data 结构 |
|------|------|-----------|
| sensor | 传感器数据 | `{sensor_type, value, unit}` |
| detection | 检测数据 | `{person_count, in_danger_zone, alert_triggered}` |

**可接收的消息类型**：

| type | 说明 | 内容 |
|------|------|------|
| control | 控制指令 | `{command, params}` |

---

### 16.3 WebSocket 消息格式

**统一消息格式**：

```json
{
  "type": "消息类型",
  "data": {
    "device_id": "设备ID",
    // ... 具体数据
  },
  "timestamp": "2024-12-14T10:30:00.000000"
}
```

---

## 17. 接口调用示例

### 17.1 Python 设备端示例

```python
import requests

SERVER_URL = "http://localhost:8000"
DEVICE_ID = "device_001"

# 上报传感器数据
def report_sensor(sensor_type, value, unit):
    response = requests.post(
        f"{SERVER_URL}/api/sensor",
        json={
            "device_id": DEVICE_ID,
            "sensor_type": sensor_type,
            "value": value,
            "unit": unit
        }
    )
    return response.status_code == 200

# 上报危险区域事件
def report_zone_event(event_type, statistics, message):
    response = requests.post(
        f"{SERVER_URL}/api/zone/event",
        json={
            "device_id": DEVICE_ID,
            "event_type": event_type,
            "statistics": statistics,
            "message": message
        }
    )
    return response.json()

# 获取生产状态
def get_status():
    response = requests.get(f"{SERVER_URL}/api/status/{DEVICE_ID}")
    return response.json()

# 使用示例
report_sensor("temperature", 65.5, "°C")
report_zone_event("enter", {"current_in_danger": 1}, "人员进入危险区")
status = get_status()
print(f"当前状态: {status['status']}")
```

### 17.2 JavaScript 前端示例

```javascript
// WebSocket 连接
const ws = new WebSocket('ws://localhost:8000/ws/dashboard');

ws.onmessage = (event) => {
  const message = JSON.parse(event.data);
  
  switch (message.type) {
    case 'sensor_update':
      console.log(`传感器: ${message.data.sensor_type} = ${message.data.value}`);
      break;
    case 'alert':
      console.log(`报警: ${message.data.message}`);
      break;
    case 'conveyor_update':
      console.log(`传送带物品数: ${message.data.items.length}`);
      break;
  }
};

// 发送控制指令
ws.send(JSON.stringify({
  type: 'control',
  data: {
    device_id: 'device_001',
    command: 'start'
  }
}));

// HTTP API 调用
async function sendControl(command) {
  const response = await fetch('/api/control', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      device_id: 'device_001',
      command: command
    })
  });
  return response.json();
}

// 使用示例
sendControl('start').then(result => {
  console.log(result.message);
});
```


---

## 18. 错误码说明

### 18.1 HTTP 错误响应

| 状态码 | 错误类型 | 示例 |
|--------|----------|------|
| 400 | 请求参数错误 | `{"detail": "未知指令: xxx"}` |
| 400 | 无效参数 | `{"detail": "无效的检测模式，必须是 zone 或 product"}` |
| 400 | 缺少必填字段 | `{"detail": "缺少视频帧数据"}` |
| 400 | 参数范围错误 | `{"detail": "保留天数必须大于0"}` |
| 404 | 资源不存在 | `{"detail": "报警记录不存在"}` |
| 404 | 规则不存在 | `{"detail": "规则不存在: xxx"}` |
| 404 | 无可用数据 | `{"detail": "没有可用的视频帧"}` |

### 18.2 业务错误码

| 场景 | 响应 |
|------|------|
| 传送带已满 | `{"success": false, "message": "无法添加物品（传送带已满或入口被占用）"}` |
| 操作成功 | `{"success": true, "message": "操作描述"}` |

---

## 19. 接口限制与约束

### 19.1 数据限制

| 限制项 | 值 | 说明 |
|--------|-----|------|
| 传感器历史查询 | 最多500条 | 单次查询上限 |
| 报警列表查询 | 最多50条 | 默认限制 |
| 检测历史查询 | 最多100条 | 默认限制 |
| 危险区域事件 | 最多100条 | 默认限制 |
| 传送带最大物品 | 8个 | 同时在线物品数 |
| 传送带速度范围 | 0.5-2.0 | 速度倍率 |

### 19.2 频率限制

| 接口类型 | 建议频率 | 说明 |
|----------|----------|------|
| 传感器上报 | 3秒/次 | 避免数据库压力 |
| 视频帧上报 | 10 FPS | 带宽与性能平衡 |
| 状态检查 | 2秒/次 | 设备端轮询 |
| 检测上报 | 按需 | 仅在检测到变化时上报 |

### 19.3 数据保留策略

| 数据类型 | 保留时间 | 清理方式 |
|----------|----------|----------|
| 传感器数据 | 7天 | 自动清理 |
| 检测记录 | 7天 | 自动清理 |
| 已处理报警 | 7天 | 自动清理 |
| 未处理报警 | 永久 | 手动处理后清理 |
| 危险区域事件 | 可配置 | 手动清理 |

---

## 附录

### A. 数据模型定义

#### A.1 传感器数据 (SensorData)

```python
class SensorData:
    id: int                    # 主键
    device_id: str             # 设备ID
    sensor_type: str           # 传感器类型
    timestamp: datetime        # 采集时间
    value: float               # 传感器值
    unit: str                  # 单位
```

#### A.2 检测记录 (DetectionRecord)

```python
class DetectionRecord:
    id: int                    # 主键
    device_id: str             # 设备ID
    timestamp: datetime        # 检测时间
    person_count: int          # 检测人数
    in_danger_zone: bool       # 是否在危险区
    alert_triggered: bool      # 是否触发报警
    image_path: str            # 截图路径
    details: str               # 详细信息JSON
```

#### A.3 生产状态 (ProductionStatus)

```python
class ProductionStatus:
    id: int                    # 主键
    device_id: str             # 设备ID (唯一)
    status: str                # 状态
    mode: str                  # 生产模式
    production_count: int      # 生产计数
    updated_at: datetime       # 更新时间
```

#### A.4 报警记录 (AlertRecord)

```python
class AlertRecord:
    id: int                    # 主键
    device_id: str             # 设备ID
    alert_type: str            # 报警类型
    timestamp: datetime        # 报警时间
    message: str               # 报警信息
    level: str                 # 级别
    resolved: bool             # 是否已处理
```

#### A.5 危险区域统计 (ZoneStatistics)

```python
class ZoneStatistics:
    id: int                    # 主键
    device_id: str             # 设备ID (唯一)
    total_entries: int         # 总进入次数
    total_exits: int           # 总离开次数
    current_in_danger: int     # 当前危险区人数
    last_entry_time: datetime  # 最后进入时间
    last_exit_time: datetime   # 最后离开时间
    updated_at: datetime       # 更新时间
    created_at: datetime       # 创建时间
```

#### A.6 危险区域事件 (ZoneEventRecord)

```python
class ZoneEventRecord:
    id: int                    # 主键
    device_id: str             # 设备ID
    event_type: str            # 事件类型 (enter/exit)
    timestamp: datetime        # 事件时间
    person_count: int          # 涉及人数
    current_in_danger: int     # 事件后危险区人数
    message: str               # 事件消息
```

### B. 枚举值定义

#### B.1 生产状态 (status)

| 值 | 说明 |
|----|------|
| running | 运行中 |
| stopped | 已停止 |
| paused | 已暂停 |

#### B.2 生产模式 (mode)

| 值 | 说明 |
|----|------|
| product_a | 产品A (蓝色方形) |
| product_b | 产品B (青色圆形) |

#### B.3 传感器类型 (sensor_type)

| 值 | 说明 | 单位 |
|----|------|------|
| temperature | 温度 | °C |
| pressure | 压力 | kPa |
| humidity | 湿度 | % |

#### B.4 报警类型 (alert_type)

| 值 | 说明 | 级别 |
|----|------|------|
| intrusion | 人员入侵 | danger |
| temperature | 温度异常 | danger/warning |
| pressure | 压力异常 | warning |
| zone_enter | 进入危险区 | danger |
| zone_exit | 离开危险区 | info |

#### B.5 报警级别 (level)

| 值 | 说明 | 颜色 |
|----|------|------|
| info | 信息 | 蓝色 |
| warning | 警告 | 橙色 |
| danger | 危险 | 红色 |

#### B.6 检测模式 (detection mode)

| 值 | 说明 |
|----|------|
| zone | 危险区域检测 |
| product | 产品检测 |

#### B.7 LED类型 (led_type)

| 值 | 说明 |
|----|------|
| alert | 报警灯 |
| product_a | 产品A指示灯 |
| product_b | 产品B指示灯 |
| running | 运行指示灯 |

### C. 文档更新记录

| 版本 | 日期 | 更新内容 |
|------|------|---------|
| v1.0 | 2024-11 | 初始版本 |
| v2.0 | 2024-12 | 完善接口文档，增加危险区域、调度、产品检测接口 |
