# 智能生产线监控系统 - 系统架构设计文档

> 版本：v2.0  
> 更新日期：2024年12月  
> 文档状态：正式发布

---

## 1. 系统概述

### 1.1 项目背景

本系统是一套面向工业生产线的智能监控与调度平台，旨在实现：
- 生产线运行状态的实时监控与远程控制
- 基于计算机视觉的危险区域人员检测与产品识别
- 多源传感器数据的采集、存储与可视化
- 智能调度规则的自动化执行

### 1.2 系统目标

| 目标维度 | 具体指标 |
|---------|---------|
| 实时性 | 传感器数据延迟 < 500ms，视频流延迟 < 1s |
| 可靠性 | 系统可用性 > 99.5%，数据持久化保障 |
| 扩展性 | 支持多设备接入，模块化架构设计 |
| 安全性 | 危险区域入侵检测响应时间 < 2s |

### 1.3 技术选型

| 层级 | 技术栈 | 选型理由 |
|-----|-------|---------|
| 前端 | Vue 3 + Element Plus + ECharts | 响应式框架，丰富的UI组件，专业图表库 |
| 后端 | FastAPI + SQLAlchemy | 高性能异步框架，原生WebSocket支持 |
| 数据库 | MySQL 8.0 | 成熟稳定，事务支持，适合结构化数据 |
| 视觉检测 | YOLOv8 + OpenCV | 轻量级目标检测，实时性能优秀 |
| 通信协议 | HTTP REST + WebSocket | 标准化接口 + 实时双向通信 |


---

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户层 (User Layer)                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Web 监控大屏 (Vue 3 SPA)                          │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │   │
│  │  │ 生产状态  │ │ 传送带   │ │ 传感器   │ │ 视频监控  │ │ 报警管理  │  │   │
│  │  │ 控制面板  │ │ 可视化   │ │ 图表    │ │ 检测结果  │ │ 调度规则  │  │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                    ┌─────────────────┴─────────────────┐
                    │ HTTP REST API    WebSocket 实时通信 │
                    └─────────────────┬─────────────────┘
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            服务层 (Service Layer)                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    FastAPI 后端服务 (Python)                         │   │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐       │   │
│  │  │ API Router │ │ WebSocket  │ │ Scheduler  │ │ Conveyor   │       │   │
│  │  │ 路由处理    │ │ Manager    │ │ Manager    │ │ Manager    │       │   │
│  │  └────────────┘ └────────────┘ └────────────┘ └────────────┘       │   │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐                      │   │
│  │  │ Database   │ │ Config     │ │ Schemas    │                      │   │
│  │  │ ORM Models │ │ Settings   │ │ Pydantic   │                      │   │
│  │  └────────────┘ └────────────┘ └────────────┘                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                    ┌─────────────────┴─────────────────┐
                    │         SQLAlchemy ORM            │
                    └─────────────────┬─────────────────┘
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            数据层 (Data Layer)                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        MySQL 数据库                                  │   │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐                │   │
│  │  │ sensor_data  │ │ detection_   │ │ production_  │                │   │
│  │  │ 传感器数据   │ │ records      │ │ status       │                │   │
│  │  └──────────────┘ └──────────────┘ └──────────────┘                │   │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐                │   │
│  │  │ alert_       │ │ zone_        │ │ zone_event_  │                │   │
│  │  │ records      │ │ statistics   │ │ records      │                │   │
│  │  └──────────────┘ └──────────────┘ └──────────────┘                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                      ▲
                    ┌─────────────────┴─────────────────┐
                    │         HTTP API 数据上报          │
                    └─────────────────┬─────────────────┘
                                      │
┌─────────────────────────────────────────────────────────────────────────────┐
│                           设备层 (Device Layer)                              │
│  ┌───────────────────────────┐    ┌───────────────────────────┐            │
│  │   树莓派 / 边缘设备        │    │      模拟器 (开发测试)     │            │
│  │  ┌─────────┐ ┌─────────┐  │    │  ┌─────────┐ ┌─────────┐  │            │
│  │  │ YOLOv8  │ │ 传感器  │  │    │  │ 传感器  │ │ 检测    │  │            │
│  │  │ 检测    │ │ 采集    │  │    │  │ 模拟    │ │ 模拟    │  │            │
│  │  └─────────┘ └─────────┘  │    │  └─────────┘ └─────────┘  │            │
│  │  ┌─────────┐ ┌─────────┐  │    │  ┌─────────────────────┐  │            │
│  │  │ GPIO    │ │ Device  │  │    │  │    Device Client    │  │            │
│  │  │ 控制    │ │ Client  │  │    │  │    HTTP 通信        │  │            │
│  │  └─────────┘ └─────────┘  │    │  └─────────────────────┘  │            │
│  └───────────────────────────┘    └───────────────────────────┘            │
└─────────────────────────────────────────────────────────────────────────────┘
```


   ### 2.2 分层架构说明

   #### 2.2.1 用户层 (Presentation Layer)

   **技术实现**：Vue 3 + Vite + Element Plus

   **核心功能模块**：

   | 模块 | 功能描述 | 关键组件 |
   |-----|---------|---------|
   | 生产状态控制 | 启动/停止/暂停生产线，切换生产模式 | `App.vue` |
   | 传送带可视化 | 实时展示传送带运行状态和物品流动 | `ConveyorBelt.vue` |
   | 传感器监控 | 温度/压力/湿度实时曲线图 | ECharts 图表 |
   | 视频监控 | 实时视频流 + 检测结果叠加显示 | Base64 图像渲染 |
   | 报警管理 | 报警列表、处理操作、全屏报警动画 | Element Plus 组件 |
   | 调度管理 | 生产计划设置、自动调度规则配置 | 表单组件 |

   **通信机制**：
   - **HTTP API**：用于控制指令发送、历史数据查询
   - **WebSocket**：用于实时数据推送（传感器、检测结果、状态变更）

   #### 2.2.2 服务层 (Business Layer)

   **技术实现**：FastAPI + Uvicorn

   **核心模块**：

   ```
   backend/app/
   ├── main.py              # 主应用入口，API路由定义
   ├── database.py          # 数据库模型与操作
   ├── schemas.py           # Pydantic 数据模型
   ├── config.py            # 配置管理
   ├── websocket_manager.py # WebSocket 连接管理
   ├── conveyor.py          # 传送带状态管理
   └── scheduler.py         # 自动调度引擎
   ```

   **关键设计**：

   1. **WebSocket 连接管理器**
      - 维护前端大屏连接池
      - 维护设备端连接映射
      - 提供广播和定向推送能力

   2. **传送带管理器**
      - 模拟传送带物品生成与移动
      - 与生产状态同步
      - 后台任务定时更新（20 FPS）

   3. **调度管理器**
      - 温度阈值自动调度（高温暂停/恢复启动）
      - 产量目标自动调度（达标停止/切换模式）
      - 规则冷却时间控制，防止频繁触发

   #### 2.2.3 数据层 (Data Layer)

   **技术实现**：MySQL 8.0 + SQLAlchemy ORM

   **数据表设计**：

   | 表名 | 用途 | 主要字段 |
   |-----|------|---------|
   | `sensor_data` | 传感器历史数据 | device_id, sensor_type, value, unit, timestamp |
   | `detection_records` | 检测记录 | device_id, person_count, in_danger_zone, alert_triggered |
   | `production_status` | 生产状态 | device_id, status, mode, production_count |
   | `alert_records` | 报警记录 | device_id, alert_type, message, level, resolved |
   | `zone_statistics` | 危险区域统计 | device_id, total_entries, total_exits, current_in_danger |
   | `zone_event_records` | 危险区域事件 | device_id, event_type, person_count, timestamp |

   #### 2.2.4 设备层 (Device Layer)

   **部署形态**：

   1. **生产环境**：树莓派 + 摄像头 + 传感器 + GPIO
   2. **开发环境**：模拟器（纯软件模拟）

   **核心组件**：

   | 组件 | 文件 | 功能 |
   |-----|------|------|
   | 统一检测系统 | `unified_detection.py` | 危险区域检测 + 产品检测，模式可切换 |
   | 危险区域检测 | `zone_detection.py` | YOLOv8 人员检测，越线报警 |
   | 产品检测 | `product_detection.py` | 颜色/形状识别，产品分类 |
   | 设备客户端 | `device_client.py` | HTTP API 封装，数据上报 |
   | 传感器模拟 | `sensor_simulator.py` | 温度/压力/湿度数据模拟 |


---

## 3. 核心模块设计

### 3.1 WebSocket 实时通信模块

#### 3.1.1 连接管理架构

```
┌─────────────────────────────────────────────────────────────┐
│                  ConnectionManager                          │
│  ┌─────────────────────┐  ┌─────────────────────────────┐  │
│  │ dashboard_connections│  │   device_connections        │  │
│  │ List[WebSocket]     │  │   Dict[device_id, WebSocket]│  │
│  │                     │  │                             │  │
│  │ • 前端大屏连接池    │  │ • 设备端连接映射           │  │
│  │ • 支持多客户端      │  │ • 按设备ID索引             │  │
│  └─────────────────────┘  └─────────────────────────────┘  │
│                                                             │
│  广播方法:                                                  │
│  • broadcast_sensor_update()   - 传感器数据更新            │
│  • broadcast_detection()       - 检测结果推送              │
│  • broadcast_alert()           - 报警信息推送              │
│  • broadcast_status_change()   - 生产状态变更              │
│  • broadcast_conveyor_update() - 传送带状态更新            │
│  • broadcast_zone_event()      - 危险区域事件              │
│  • broadcast_led_status()      - LED状态变化               │
└─────────────────────────────────────────────────────────────┘
```

#### 3.1.2 消息格式规范

所有 WebSocket 消息采用统一的 JSON 格式：

```json
{
  "type": "消息类型",
  "data": {
    "device_id": "设备ID",
    // ... 具体数据字段
  },
  "timestamp": "ISO 8601 时间戳"
}
```

**消息类型枚举**：

| type | 描述 | 触发场景 |
|------|------|---------|
| `sensor_update` | 传感器数据更新 | 设备上报传感器数据 |
| `detection` | 检测结果 | 人员检测完成 |
| `alert` | 报警通知 | 触发报警条件 |
| `status_change` | 状态变更 | 生产状态/模式改变 |
| `conveyor_update` | 传送带更新 | 传送带状态变化 |
| `zone_event` | 危险区域事件 | 人员进入/离开危险区 |
| `zone_statistics` | 区域统计更新 | 统计数据变化 |
| `video_frame` | 视频帧 | 实时视频流推送 |
| `led_status` | LED状态 | 指示灯状态变化 |
| `schedule_action` | 调度动作 | 自动调度触发 |
| `product_detection` | 产品检测 | 产品识别结果 |
| `detection_mode_change` | 检测模式切换 | 切换检测模式 |

### 3.2 传送带模拟模块

#### 3.2.1 状态机设计

```
                    ┌─────────────┐
                    │   stopped   │
                    │  (初始状态)  │
                    └──────┬──────┘
                           │ start
                           ▼
    ┌──────────────────────────────────────────┐
    │                                          │
    │  ┌─────────────┐      ┌─────────────┐   │
    │  │   running   │◄────►│   paused    │   │
    │  │  (运行中)   │pause │  (已暂停)   │   │
    │  └──────┬──────┘      └──────┬──────┘   │
    │         │                    │          │
    │         └────────┬───────────┘          │
    │                  │ stop                 │
    │                  ▼                      │
    │          ┌─────────────┐                │
    │          │   stopped   │                │
    │          │  (已停止)   │                │
    │          └─────────────┘                │
    └──────────────────────────────────────────┘
```

#### 3.2.2 物品生命周期

```
生成 ──► 移动 ──► 完成
 │        │        │
 │        │        └─► production_count++
 │        │            广播状态更新
 │        │            检查调度规则
 │        │
 │        └─► position += speed * delta_time
 │            每帧更新位置
 │
 └─► 检查入口空间
     检查最大物品数
     创建 ConveyorItem
```

#### 3.2.3 产品类型配置

| 产品类型 | 颜色 | 形状 | 显示颜色 |
|---------|------|------|---------|
| product_a | 蓝色 | box (方形) | #3a91c7 |
| product_b | 青色 | cylinder (圆柱) | #2db7b5 |


### 3.3 自动调度模块

#### 3.3.1 调度规则引擎

```
┌─────────────────────────────────────────────────────────────┐
│                    SchedulerManager                         │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                   调度规则 (Rules)                   │   │
│  │  ┌─────────────────┐  ┌─────────────────┐          │   │
│  │  │ temp_danger_    │  │ temp_recover_   │          │   │
│  │  │ pause           │  │ start           │          │   │
│  │  │ 高温自动暂停    │  │ 温度恢复启动   │          │   │
│  │  │ threshold: 95°C │  │ threshold: 80°C │          │   │
│  │  └─────────────────┘  └─────────────────┘          │   │
│  │  ┌─────────────────┐                               │   │
│  │  │ production_     │                               │   │
│  │  │ complete        │                               │   │
│  │  │ 产量达标停止    │                               │   │
│  │  │ threshold: 动态 │                               │   │
│  │  └─────────────────┘                               │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                   生产计划 (Plan)                    │   │
│  │  • target_count: 目标产量                           │   │
│  │  • auto_stop_on_complete: 达标后自动停止            │   │
│  │  • auto_switch_mode: 达标后切换模式                 │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

#### 3.3.2 规则触发流程

```
传感器数据/产量更新
        │
        ▼
┌───────────────────┐
│ 遍历所有启用规则  │
└────────┬──────────┘
         │
         ▼
┌───────────────────┐     否
│ 检查冷却时间      │────────► 跳过
└────────┬──────────┘
         │ 是
         ▼
┌───────────────────┐     否
│ 检查触发条件      │────────► 跳过
└────────┬──────────┘
         │ 是
         ▼
┌───────────────────┐
│ 执行调度动作      │
│ • 更新数据库状态  │
│ • 同步传送带      │
│ • 广播状态变更    │
│ • 记录触发时间    │
└───────────────────┘
```

#### 3.3.3 默认调度规则

| 规则ID | 名称 | 类型 | 条件 | 阈值 | 动作 | 冷却时间 |
|--------|------|------|------|------|------|---------|
| temp_danger_pause | 高温自动暂停 | temperature | > | 95°C | pause | 30s |
| temp_recover_start | 温度恢复启动 | temperature_recover | < | 80°C | start | 30s |
| production_complete | 产量达标停止 | production | >= | 动态 | stop | 5s |

### 3.4 视觉检测模块

#### 3.4.1 检测模式架构

```
┌─────────────────────────────────────────────────────────────┐
│                 UnifiedDetectionSystem                      │
│                                                             │
│  ┌─────────────────────┐  ┌─────────────────────┐          │
│  │    ZoneDetector     │  │   ProductDetector   │          │
│  │   (危险区域检测)    │  │    (产品检测)       │          │
│  │                     │  │                     │          │
│  │ • YOLOv8 人员检测   │  │ • HSV 颜色检测      │          │
│  │ • 多边形区域判定    │  │ • 轮廓形状分析      │          │
│  │ • 人员状态追踪      │  │ • 产品分类识别      │          │
│  │ • 进入/离开事件     │  │                     │          │
│  └─────────────────────┘  └─────────────────────┘          │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                  PersonTracker                       │   │
│  │  • 基于位置的简单追踪                               │   │
│  │  • 状态变化检测 (SAFE ↔ DANGER)                     │   │
│  │  • 超时清理机制                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                  ZoneStatistics                      │   │
│  │  • total_entries: 总进入次数                        │   │
│  │  • total_exits: 总离开次数                          │   │
│  │  • current_in_danger: 当前危险区人数                │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

#### 3.4.2 危险区域检测流程

```
摄像头帧输入
      │
      ▼
┌─────────────────┐
│ 跳帧检测判断    │ ─── 非检测帧 ──► 使用上次结果
└────────┬────────┘
         │ 检测帧
         ▼
┌─────────────────┐
│ 图像缩放        │ 640x480 → 320x320
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ YOLOv8 推理     │ 仅检测 person 类别
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 坐标还原        │ 缩放比例映射
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 人员追踪更新    │ PersonTracker.update()
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 状态变化检测    │
│ • 进入危险区    │ ──► 触发报警回调
│ • 离开危险区    │ ──► 触发离开回调
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 绘制可视化      │
│ • 区域填充      │
│ • 边界框        │
│ • 统计信息      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 视频流推送      │ Base64 编码 → HTTP POST
└─────────────────┘
```

#### 3.4.3 产品检测算法

**颜色检测 (HSV 空间)**：

| 产品 | H 范围 | S 范围 | V 范围 |
|------|--------|--------|--------|
| product_a (蓝色) | 100-130 | 100-255 | 100-255 |
| product_b (青色) | 75-95 | 100-255 | 100-255 |

**形状检测 (圆形度)**：

```
圆形度 = 4π × 面积 / 周长²

圆形度 > 0.7  →  圆形 (product_b)
圆形度 ≤ 0.7  →  方形 (product_a)
```


---

## 4. 数据流设计

### 4.1 传感器数据流

```
┌──────────────┐     HTTP POST      ┌──────────────┐
│   设备端     │ ─────────────────► │   后端服务   │
│ (传感器采集) │   /api/sensor      │              │
└──────────────┘                    └──────┬───────┘
                                           │
                    ┌──────────────────────┼──────────────────────┐
                    │                      │                      │
                    ▼                      ▼                      ▼
           ┌──────────────┐      ┌──────────────┐      ┌──────────────┐
           │  数据库存储  │      │  阈值检查    │      │  WebSocket   │
           │ sensor_data  │      │ 报警触发     │      │  广播推送    │
           └──────────────┘      └──────────────┘      └──────┬───────┘
                                                              │
                                                              ▼
                                                     ┌──────────────┐
                                                     │   前端大屏   │
                                                     │  实时图表    │
                                                     └──────────────┘
```

### 4.2 检测数据流

```
┌──────────────┐     HTTP POST      ┌──────────────┐
│   设备端     │ ─────────────────► │   后端服务   │
│ (YOLOv8检测) │  /api/zone/event   │              │
└──────────────┘                    └──────┬───────┘
                                           │
              ┌────────────────────────────┼────────────────────────────┐
              │                            │                            │
              ▼                            ▼                            ▼
     ┌──────────────┐           ┌──────────────┐           ┌──────────────┐
     │  统计更新    │           │  事件记录    │           │  报警记录    │
     │ zone_        │           │ zone_event_  │           │ alert_       │
     │ statistics   │           │ records      │           │ records      │
     └──────────────┘           └──────────────┘           └──────────────┘
              │                            │                            │
              └────────────────────────────┼────────────────────────────┘
                                           │
                                           ▼
                                  ┌──────────────┐
                                  │  WebSocket   │
                                  │  广播推送    │
                                  │ • zone_event │
                                  │ • alert      │
                                  │ • statistics │
                                  └──────┬───────┘
                                         │
                                         ▼
                                ┌──────────────┐
                                │   前端大屏   │
                                │ • 报警动画   │
                                │ • 统计更新   │
                                │ • 视频叠加   │
                                └──────────────┘
```

### 4.3 控制指令流

```
┌──────────────┐     HTTP POST      ┌──────────────┐
│   前端大屏   │ ─────────────────► │   后端服务   │
│  (用户操作)  │   /api/control     │              │
└──────────────┘                    └──────┬───────┘
                                           │
              ┌────────────────────────────┼────────────────────────────┐
              │                            │                            │
              ▼                            ▼                            ▼
     ┌──────────────┐           ┌──────────────┐           ┌──────────────┐
     │  状态更新    │           │  传送带同步  │           │  WebSocket   │
     │ production_  │           │ ConveyorMgr  │           │  广播推送    │
     │ status       │           │ sync_with_   │           │ status_      │
     │              │           │ production() │           │ change       │
     └──────────────┘           └──────────────┘           └──────────────┘
                                                                   │
                                                                   ▼
                                                          ┌──────────────┐
                                                          │   前端大屏   │
                                                          │  状态更新    │
                                                          └──────────────┘
                                                                   │
                                                                   ▼
                                                          ┌──────────────┐
                                                          │   设备端     │
                                                          │ (可选推送)   │
                                                          └──────────────┘
```

### 4.4 视频流数据流

```
┌──────────────┐     HTTP POST      ┌──────────────┐     WebSocket      ┌──────────────┐
│   设备端     │ ─────────────────► │   后端服务   │ ─────────────────► │   前端大屏   │
│ (摄像头)     │  /api/video/frame  │              │   video_frame      │              │
│              │                    │              │                    │              │
│ • 帧捕获     │   Base64 JPEG      │ • 帧缓存     │   Base64 JPEG      │ • 图像渲染   │
│ • 检测叠加   │   + 检测信息       │ • 广播分发   │   + 检测信息       │ • 检测显示   │
│ • JPEG压缩   │                    │              │                    │              │
└──────────────┘                    └──────────────┘                    └──────────────┘

帧率控制: 10 FPS
压缩质量: 50%
分辨率: 640x480
```


---

## 5. 部署架构

### 5.1 开发环境部署

```
┌─────────────────────────────────────────────────────────────┐
│                      开发机 (Windows/Mac)                    │
│                                                             │
│  ┌─────────────────┐  ┌─────────────────┐                  │
│  │   前端开发服务   │  │   后端开发服务   │                  │
│  │   Vite Dev      │  │   Uvicorn       │                  │
│  │   Port: 3000    │  │   Port: 8000    │                  │
│  │                 │  │   reload=True   │                  │
│  └────────┬────────┘  └────────┬────────┘                  │
│           │                    │                           │
│           │    Proxy           │                           │
│           └────────────────────┘                           │
│                                                             │
│  ┌─────────────────┐  ┌─────────────────┐                  │
│  │   MySQL 数据库   │  │   模拟器        │                  │
│  │   Port: 3306    │  │   simulator/    │                  │
│  └─────────────────┘  └─────────────────┘                  │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 生产环境部署

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              生产环境                                        │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                           服务器 (云/本地)                             │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐       │ │
│  │  │   Nginx         │  │   FastAPI       │  │   MySQL         │       │ │
│  │  │   反向代理      │  │   后端服务      │  │   数据库        │       │ │
│  │  │   静态资源      │  │   Port: 8000    │  │   Port: 3306    │       │ │
│  │  │   Port: 80/443  │  │                 │  │                 │       │ │
│  │  └────────┬────────┘  └────────┬────────┘  └─────────────────┘       │ │
│  │           │                    │                                      │ │
│  │           └────────────────────┘                                      │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                      ▲                                      │
│                                      │ HTTP/WebSocket                       │
│                                      │                                      │
│  ┌───────────────────────────────────┴───────────────────────────────────┐ │
│  │                           边缘设备层                                   │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐       │ │
│  │  │   树莓派 #1     │  │   树莓派 #2     │  │   树莓派 #N     │       │ │
│  │  │   device_001    │  │   device_002    │  │   device_00N    │       │ │
│  │  │   • 摄像头      │  │   • 摄像头      │  │   • 摄像头      │       │ │
│  │  │   • 传感器      │  │   • 传感器      │  │   • 传感器      │       │ │
│  │  │   • GPIO        │  │   • GPIO        │  │   • GPIO        │       │ │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘       │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.3 启动流程

#### 后端服务启动

```bash
# 1. 安装依赖
cd backend
pip install -r requirements.txt

# 2. 初始化数据库
mysql -u root -p < init_db.sql

# 3. 启动服务
python run.py
```

#### 前端服务启动

```bash
# 1. 安装依赖
cd frontend
npm install

# 2. 开发模式
npm run dev

# 3. 生产构建
npm run build
```

#### 设备端启动

```bash
# 模拟器模式
cd simulator
python main.py

# 真实设备模式
cd project
python unified_detection.py
```

---

## 6. 安全设计

### 6.1 通信安全

| 层级 | 措施 | 说明 |
|------|------|------|
| 传输层 | HTTPS/WSS | 生产环境启用 TLS 加密 |
| 应用层 | CORS 配置 | 限制允许的源域名 |
| 认证层 | Token 认证 | 可扩展 JWT 认证机制 |

### 6.2 数据安全

| 措施 | 实现 |
|------|------|
| 数据清理 | 自动清理 7 天前的历史数据 |
| 敏感信息 | 数据库密码通过环境变量配置 |
| SQL 注入 | SQLAlchemy ORM 参数化查询 |

### 6.3 报警阈值配置

| 参数 | 默认值 | 说明 |
|------|--------|------|
| TEMP_WARNING_THRESHOLD | 80°C | 温度警告阈值 |
| TEMP_DANGER_THRESHOLD | 95°C | 温度危险阈值 |
| DATA_RETENTION_DAYS | 7 天 | 数据保留天数 |
| AUTO_CLEANUP_INTERVAL | 6 小时 | 自动清理间隔 |

---

## 7. 性能优化

### 7.1 后端优化

| 优化点 | 措施 |
|--------|------|
| 异步处理 | FastAPI 原生异步支持 |
| 数据库连接池 | SQLAlchemy 连接池管理 |
| 传送带更新 | 后台任务 20 FPS 批量更新 |
| WebSocket | 断开连接自动清理 |

### 7.2 视觉检测优化

| 优化点 | 措施 | 效果 |
|--------|------|------|
| 模型选择 | YOLOv8n (最轻量) | 推理速度提升 |
| 输入尺寸 | 320x320 | 减少计算量 |
| 跳帧检测 | 每 2-3 帧检测一次 | 降低 CPU 占用 |
| 视频压缩 | JPEG 质量 50% | 减少带宽占用 |

### 7.3 前端优化

| 优化点 | 措施 |
|--------|------|
| 图表更新 | 限制数据点数量 (30点) |
| WebSocket | 自动重连机制 |
| 动画性能 | requestAnimationFrame |
| 组件懒加载 | Vue 异步组件 |

---

## 8. 扩展性设计

### 8.1 多设备支持

系统设计支持多设备接入：

- 每个设备有唯一的 `device_id`
- 数据表均以 `device_id` 为索引
- WebSocket 支持设备级别的连接管理
- 传送带管理器按设备 ID 独立实例化

### 8.2 模块化架构

```
backend/app/
├── main.py              # 可拆分为多个 Router
├── routers/             # 可扩展的路由模块
│   ├── sensor.py
│   ├── detection.py
│   ├── control.py
│   └── scheduler.py
├── services/            # 业务逻辑层
├── models/              # 数据模型
└── utils/               # 工具函数
```

### 8.3 可扩展的检测模式

当前支持：
- `zone`: 危险区域检测
- `product`: 产品检测

可扩展：
- `quality`: 质量检测
- `defect`: 缺陷检测
- `counting`: 计数检测

---

## 附录

### A. 技术栈版本

| 组件 | 版本 |
|------|------|
| Python | 3.9+ |
| FastAPI | 0.104.1 |
| SQLAlchemy | 2.0.23 |
| Vue | 3.3.8 |
| Vite | 5.0.0 |
| YOLOv8 | ultralytics |
| MySQL | 8.0 |

### B. 端口规划

| 服务 | 端口 | 说明 |
|------|------|------|
| 后端 API | 8000 | FastAPI 服务 |
| 前端开发 | 3000 | Vite 开发服务器 |
| MySQL | 3306 | 数据库服务 |
| WebSocket | 8000 | 复用后端端口 |

### C. 文档更新记录

| 版本 | 日期 | 更新内容 |
|------|------|---------|
| v1.0 | 2024-11 | 初始版本 |
| v2.0 | 2024-12 | 完善架构设计，增加人员追踪、调度模块 |
