# 智能生产线监控与调度系统 - 系统架构设计文档

## 1. 系统概述

### 1.1 项目背景
本系统是一个基于多源数据的智能生产线监控与调度系统，用于模拟小型生产线或设备集群的监控与调度。系统能够模拟多种数据输入源，并在中心服务器进行聚合、可视化和远程控制。

### 1.2 功能概述
- **生产线模块**：目标检测（YOLOv8）、传感器数据采集
- **中心控制与数据服务模块**：数据聚合、控制指令下发、API服务
- **可视化与管理界面**：实时监控大屏、远程调度控制

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        前端展示层 (Vue3)                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │  实时监控大屏 │  │  报警管理   │  │  远程控制   │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
                              │
                    HTTP REST API / WebSocket
                              │
┌─────────────────────────────────────────────────────────────────┐
│                     后端服务层 (FastAPI)                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │  数据聚合    │  │  控制指令   │  │  WebSocket  │              │
│  │  服务       │  │  服务       │  │  推送服务   │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
                              │
                         SQLAlchemy ORM
                              │
┌─────────────────────────────────────────────────────────────────┐
│                       数据存储层 (MySQL)                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ 检测记录表   │  │ 传感器数据表 │  │ 报警记录表  │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
                              │
                    HTTP/WebSocket 上报
                              │
┌─────────────────────────────────────────────────────────────────┐
│                       设备层 (树莓派)                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ 摄像头检测   │  │ 温度传感器  │  │ LED/蜂鸣器  │              │
│  │ (YOLOv8)    │  │ 压力传感器  │  │ GPIO控制    │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 技术栈

| 层级 | 技术选型 | 说明 |
|------|---------|------|
| 前端 | Vue3 + Element Plus + ECharts | 响应式UI框架 + 组件库 + 图表库 |
| 后端 | FastAPI + SQLAlchemy | 高性能异步框架 + ORM |
| 数据库 | MySQL | 关系型数据库 |
| 通信 | HTTP REST + WebSocket | 请求响应 + 实时推送 |
| 边缘设备 | Python + OpenCV + YOLOv8 | 图像处理 + 目标检测 |

## 3. 模块设计

### 3.1 生产线模块（树莓派端）

#### 3.1.1 目标检测模块
- **功能**：利用摄像头检测人员是否进入危险区域
- **技术**：YOLOv8n + OpenCV
- **输出**：检测结果（人数、是否在危险区、是否报警）

#### 3.1.2 传感器数据采集
- **功能**：采集温度、压力、湿度等传感器数据
- **接口**：GPIO / I2C / SPI
- **频率**：每3秒采集一次

#### 3.1.3 报警控制
- **功能**：检测到异常时控制LED和蜂鸣器报警
- **接口**：GPIO输出

### 3.2 中心控制与数据服务模块（后端）

#### 3.2.1 数据聚合服务
- 接收设备上报的检测数据和传感器数据
- 数据验证和清洗
- 存储到MySQL数据库

#### 3.2.2 控制指令服务
- 接收前端的控制指令
- 更新数据库状态
- 通过WebSocket下发到设备

#### 3.2.3 WebSocket推送服务
- 管理前端和设备的WebSocket连接
- 实时推送传感器数据更新
- 实时推送报警信息

### 3.3 可视化与管理界面（前端）

#### 3.3.1 实时监控大屏
- 生产状态显示（运行中/停止/暂停）
- 温度、压力实时曲线
- 检测状态显示
- 报警信息列表

#### 3.3.2 远程调度控制
- 启动/停止/暂停生产线
- 切换生产模式（产品A/产品B）
- 处理报警

## 4. 接口设计

### 4.1 HTTP REST API

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/detection` | POST | 上报检测数据 |
| `/api/sensor` | POST | 上报传感器数据 |
| `/api/status/{device_id}` | GET/PUT | 获取/更新生产状态 |
| `/api/control` | POST | 发送控制指令 |
| `/api/alerts` | GET | 获取报警列表 |
| `/api/dashboard` | GET | 获取仪表盘数据 |

### 4.2 WebSocket接口

| 端点 | 说明 |
|------|------|
| `/ws/dashboard` | 前端大屏连接 |
| `/ws/device/{device_id}` | 设备连接 |

### 4.3 WebSocket消息格式

```json
{
  "type": "sensor_update | detection | alert | status_change",
  "data": { ... },
  "timestamp": "2024-12-11T15:30:00"
}
```

## 5. 数据库设计

### 5.1 ER图

```
detection_records     sensor_data          production_status
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│ id           │     │ id           │     │ id           │
│ device_id    │     │ device_id    │     │ device_id    │
│ timestamp    │     │ sensor_type  │     │ status       │
│ person_count │     │ timestamp    │     │ mode         │
│ in_danger    │     │ value        │     │ count        │
│ alert        │     │ unit         │     │ updated_at   │
└──────────────┘     └──────────────┘     └──────────────┘

alert_records
┌──────────────┐
│ id           │
│ device_id    │
│ alert_type   │
│ timestamp    │
│ message      │
│ level        │
│ resolved     │
└──────────────┘
```

## 6. 部署架构

### 6.1 开发环境
- 后端：本地运行 FastAPI (localhost:8000)
- 前端：本地运行 Vite (localhost:3000)
- 数据库：本地 MySQL
- 模拟器：本地运行传感器模拟器

### 6.2 生产环境
- 后端：服务器部署
- 前端：Nginx静态托管
- 数据库：MySQL服务器
- 设备：树莓派运行检测程序

## 7. 运行说明

### 7.1 启动后端
```bash
cd backend
pip install -r requirements.txt
python run.py
```

### 7.2 启动前端
```bash
cd frontend
npm install
npm run dev
```

### 7.3 启动模拟器（无硬件时）
```bash
cd backend
python simulator.py
```

## 8. 作者信息
- 项目名称：基于多源数据的智能生产线监控与调度系统
- 完成日期：2024年12月
