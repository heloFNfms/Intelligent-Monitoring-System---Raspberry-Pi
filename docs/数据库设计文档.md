# 智能生产线监控系统 - 数据库设计文档

> 版本：v2.0  
> 更新日期：2024年12月  
> 数据库：MySQL 8.0

---

## 1. 数据库概述

### 1.1 数据库信息

| 项目 | 值 |
|------|-----|
| 数据库名 | production_monitor |
| 字符集 | utf8mb4 |
| 排序规则 | utf8mb4_unicode_ci |
| 存储引擎 | InnoDB |

### 1.2 表清单

| 表名 | 说明 | 数据量级 |
|------|------|---------|
| sensor_data | 传感器数据 | 高（每3秒/设备） |
| detection_records | 检测记录 | 中（按需上报） |
| production_status | 生产状态 | 低（每设备1条） |
| alert_records | 报警记录 | 中（事件触发） |
| zone_statistics | 危险区域统计 | 低（每设备1条） |
| zone_event_records | 危险区域事件 | 中（事件触发） |

---

## 2. 表结构设计

### 2.1 传感器数据表 (sensor_data)

存储温度、压力、湿度等传感器的历史数据。

```sql
CREATE TABLE sensor_data (
    id INT AUTO_INCREMENT PRIMARY KEY,
    device_id VARCHAR(50) NOT NULL COMMENT '设备ID',
    sensor_type VARCHAR(20) NOT NULL COMMENT '传感器类型: temperature/pressure/humidity',
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '采集时间',
    value FLOAT NOT NULL COMMENT '传感器值',
    unit VARCHAR(10) COMMENT '单位',
    
    INDEX idx_device_sensor (device_id, sensor_type),
    INDEX idx_timestamp (timestamp)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**字段说明**：

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INT | PK, AUTO_INCREMENT | 主键 |
| device_id | VARCHAR(50) | NOT NULL, INDEX | 设备ID |
| sensor_type | VARCHAR(20) | NOT NULL | 传感器类型 |
| timestamp | DATETIME | DEFAULT NOW | 采集时间 |
| value | FLOAT | NOT NULL | 传感器值 |
| unit | VARCHAR(10) | - | 单位 |

**索引设计**：
- `idx_device_sensor`: 支持按设备+类型查询最新值
- `idx_timestamp`: 支持按时间范围查询和清理


---

### 2.2 检测记录表 (detection_records)

存储摄像头人员检测的历史记录。

```sql
CREATE TABLE detection_records (
    id INT AUTO_INCREMENT PRIMARY KEY,
    device_id VARCHAR(50) NOT NULL COMMENT '设备ID',
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '检测时间',
    person_count INT DEFAULT 0 COMMENT '检测到的人数',
    in_danger_zone BOOLEAN DEFAULT FALSE COMMENT '是否在危险区域',
    alert_triggered BOOLEAN DEFAULT FALSE COMMENT '是否触发报警',
    image_path VARCHAR(255) COMMENT '截图路径',
    details TEXT COMMENT '详细信息JSON',
    
    INDEX idx_device_id (device_id),
    INDEX idx_timestamp (timestamp)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**字段说明**：

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INT | PK | 主键 |
| device_id | VARCHAR(50) | NOT NULL, INDEX | 设备ID |
| timestamp | DATETIME | DEFAULT NOW | 检测时间 |
| person_count | INT | DEFAULT 0 | 检测人数 |
| in_danger_zone | BOOLEAN | DEFAULT FALSE | 是否在危险区 |
| alert_triggered | BOOLEAN | DEFAULT FALSE | 是否触发报警 |
| image_path | VARCHAR(255) | - | 截图路径 |
| details | TEXT | - | 详细信息(JSON) |

---

### 2.3 生产状态表 (production_status)

存储每个设备的当前生产状态，每设备一条记录。

```sql
CREATE TABLE production_status (
    id INT AUTO_INCREMENT PRIMARY KEY,
    device_id VARCHAR(50) NOT NULL UNIQUE COMMENT '设备ID',
    status VARCHAR(20) DEFAULT 'stopped' COMMENT '状态: running/stopped/paused',
    mode VARCHAR(20) DEFAULT 'product_a' COMMENT '生产模式: product_a/product_b',
    production_count INT DEFAULT 0 COMMENT '累计生产数量',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_device_id (device_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**字段说明**：

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INT | PK | 主键 |
| device_id | VARCHAR(50) | UNIQUE | 设备ID（唯一） |
| status | VARCHAR(20) | DEFAULT 'stopped' | 运行状态 |
| mode | VARCHAR(20) | DEFAULT 'product_a' | 生产模式 |
| production_count | INT | DEFAULT 0 | 累计产量 |
| updated_at | DATETIME | AUTO UPDATE | 更新时间 |

**状态枚举**：
- `running`: 运行中
- `stopped`: 已停止
- `paused`: 已暂停

**模式枚举**：
- `product_a`: 产品A（蓝色方形）
- `product_b`: 产品B（青色圆形）

---

### 2.4 报警记录表 (alert_records)

存储所有类型的报警记录。

```sql
CREATE TABLE alert_records (
    id INT AUTO_INCREMENT PRIMARY KEY,
    device_id VARCHAR(50) NOT NULL COMMENT '设备ID',
    alert_type VARCHAR(20) NOT NULL COMMENT '报警类型',
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '报警时间',
    message VARCHAR(255) COMMENT '报警信息',
    level VARCHAR(10) DEFAULT 'warning' COMMENT '级别: info/warning/danger',
    resolved BOOLEAN DEFAULT FALSE COMMENT '是否已处理',
    
    INDEX idx_device_id (device_id),
    INDEX idx_resolved (resolved),
    INDEX idx_timestamp (timestamp)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**字段说明**：

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INT | PK | 主键 |
| device_id | VARCHAR(50) | NOT NULL, INDEX | 设备ID |
| alert_type | VARCHAR(20) | NOT NULL | 报警类型 |
| timestamp | DATETIME | DEFAULT NOW | 报警时间 |
| message | VARCHAR(255) | - | 报警信息 |
| level | VARCHAR(10) | DEFAULT 'warning' | 报警级别 |
| resolved | BOOLEAN | DEFAULT FALSE, INDEX | 是否已处理 |

**报警类型枚举**：
- `intrusion`: 人员入侵
- `temperature`: 温度异常
- `pressure`: 压力异常
- `zone_enter`: 进入危险区
- `zone_exit`: 离开危险区

**报警级别枚举**：
- `info`: 信息（蓝色）
- `warning`: 警告（橙色）
- `danger`: 危险（红色）

---

### 2.5 危险区域统计表 (zone_statistics)

存储每个设备的危险区域统计信息，每设备一条记录。

```sql
CREATE TABLE zone_statistics (
    id INT AUTO_INCREMENT PRIMARY KEY,
    device_id VARCHAR(50) NOT NULL UNIQUE COMMENT '设备ID',
    total_entries INT DEFAULT 0 COMMENT '总进入次数',
    total_exits INT DEFAULT 0 COMMENT '总离开次数',
    current_in_danger INT DEFAULT 0 COMMENT '当前危险区人数',
    last_entry_time DATETIME NULL COMMENT '最后进入时间',
    last_exit_time DATETIME NULL COMMENT '最后离开时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_device_id (device_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**字段说明**：

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INT | PK | 主键 |
| device_id | VARCHAR(50) | UNIQUE | 设备ID（唯一） |
| total_entries | INT | DEFAULT 0 | 总进入次数 |
| total_exits | INT | DEFAULT 0 | 总离开次数 |
| current_in_danger | INT | DEFAULT 0 | 当前危险区人数 |
| last_entry_time | DATETIME | NULL | 最后进入时间 |
| last_exit_time | DATETIME | NULL | 最后离开时间 |
| updated_at | DATETIME | AUTO UPDATE | 更新时间 |
| created_at | DATETIME | DEFAULT NOW | 创建时间 |

---

### 2.6 危险区域事件记录表 (zone_event_records)

存储每次进入/离开危险区域的详细事件记录。

```sql
CREATE TABLE zone_event_records (
    id INT AUTO_INCREMENT PRIMARY KEY,
    device_id VARCHAR(50) NOT NULL COMMENT '设备ID',
    event_type VARCHAR(10) NOT NULL COMMENT '事件类型: enter/exit',
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '事件时间',
    person_count INT DEFAULT 1 COMMENT '涉及人数',
    current_in_danger INT DEFAULT 0 COMMENT '事件后危险区人数',
    message VARCHAR(255) COMMENT '事件消息',
    
    INDEX idx_device_id (device_id),
    INDEX idx_event_type (event_type),
    INDEX idx_timestamp (timestamp)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**字段说明**：

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INT | PK | 主键 |
| device_id | VARCHAR(50) | NOT NULL, INDEX | 设备ID |
| event_type | VARCHAR(10) | NOT NULL, INDEX | 事件类型 |
| timestamp | DATETIME | DEFAULT NOW, INDEX | 事件时间 |
| person_count | INT | DEFAULT 1 | 涉及人数 |
| current_in_danger | INT | DEFAULT 0 | 事件后危险区人数 |
| message | VARCHAR(255) | - | 事件消息 |

**事件类型枚举**：
- `enter`: 进入危险区
- `exit`: 离开危险区


---

## 3. ER 关系图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              数据库 ER 图                                    │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐         ┌─────────────────┐         ┌─────────────────┐
│  sensor_data    │         │ detection_      │         │ alert_records   │
├─────────────────┤         │ records         │         ├─────────────────┤
│ PK id           │         ├─────────────────┤         │ PK id           │
│    device_id    │◄───────►│ PK id           │◄───────►│    device_id    │
│    sensor_type  │         │    device_id    │         │    alert_type   │
│    timestamp    │         │    timestamp    │         │    timestamp    │
│    value        │         │    person_count │         │    message      │
│    unit         │         │    in_danger_   │         │    level        │
└─────────────────┘         │    zone         │         │    resolved     │
                            │    alert_       │         └─────────────────┘
                            │    triggered    │
                            │    image_path   │
                            │    details      │
                            └─────────────────┘

┌─────────────────┐         ┌─────────────────┐         ┌─────────────────┐
│ production_     │         │ zone_           │         │ zone_event_     │
│ status          │         │ statistics      │         │ records         │
├─────────────────┤         ├─────────────────┤         ├─────────────────┤
│ PK id           │         │ PK id           │         │ PK id           │
│ UK device_id    │◄───────►│ UK device_id    │◄───────►│    device_id    │
│    status       │         │    total_       │         │    event_type   │
│    mode         │         │    entries      │         │    timestamp    │
│    production_  │         │    total_exits  │         │    person_count │
│    count        │         │    current_in_  │         │    current_in_  │
│    updated_at   │         │    danger       │         │    danger       │
└─────────────────┘         │    last_entry_  │         │    message      │
                            │    time         │         └─────────────────┘
                            │    last_exit_   │
                            │    time         │
                            │    updated_at   │
                            │    created_at   │
                            └─────────────────┘

关系说明：
• 所有表通过 device_id 关联
• production_status 和 zone_statistics 每设备一条记录 (1:1)
• 其他表与设备为一对多关系 (1:N)
```

---

## 4. 索引设计

### 4.1 索引清单

| 表名 | 索引名 | 字段 | 类型 | 用途 |
|------|--------|------|------|------|
| sensor_data | idx_device_sensor | device_id, sensor_type | 复合 | 查询最新传感器值 |
| sensor_data | idx_timestamp | timestamp | 单列 | 时间范围查询、数据清理 |
| detection_records | idx_device_id | device_id | 单列 | 按设备查询 |
| detection_records | idx_timestamp | timestamp | 单列 | 时间范围查询 |
| production_status | idx_device_id | device_id | 唯一 | 按设备查询 |
| alert_records | idx_device_id | device_id | 单列 | 按设备查询 |
| alert_records | idx_resolved | resolved | 单列 | 查询未处理报警 |
| alert_records | idx_timestamp | timestamp | 单列 | 时间范围查询 |
| zone_statistics | idx_device_id | device_id | 唯一 | 按设备查询 |
| zone_event_records | idx_device_id | device_id | 单列 | 按设备查询 |
| zone_event_records | idx_event_type | event_type | 单列 | 按事件类型查询 |
| zone_event_records | idx_timestamp | timestamp | 单列 | 时间范围查询 |

### 4.2 查询优化建议

1. **传感器最新值查询**：使用 `idx_device_sensor` 复合索引
   ```sql
   SELECT * FROM sensor_data 
   WHERE device_id = ? AND sensor_type = ?
   ORDER BY timestamp DESC LIMIT 1;
   ```

2. **未处理报警查询**：使用 `idx_resolved` 索引
   ```sql
   SELECT * FROM alert_records 
   WHERE resolved = FALSE
   ORDER BY timestamp DESC;
   ```

3. **数据清理**：使用 `idx_timestamp` 索引
   ```sql
   DELETE FROM sensor_data 
   WHERE timestamp < DATE_SUB(NOW(), INTERVAL 7 DAY);
   ```

---

## 5. 数据维护

### 5.1 自动清理策略

系统配置自动清理任务，每6小时执行一次：

```python
# 清理配置
DATA_RETENTION_DAYS = 7        # 数据保留天数
AUTO_CLEANUP_INTERVAL = 21600  # 清理间隔（秒）= 6小时
```

**清理逻辑**：
1. 清理 `sensor_data` 表中超过7天的数据
2. 清理 `detection_records` 表中超过7天的数据
3. 清理 `alert_records` 表中超过7天且已处理的报警

### 5.2 手动清理接口

```bash
# 清理7天前的数据
DELETE /api/data/cleanup?days_to_keep=7

# 重置危险区域统计（不清除事件记录）
DELETE /api/zone/statistics/{device_id}

# 重置危险区域统计（同时清除事件记录）
DELETE /api/zone/statistics/{device_id}?clear_events=true
```

### 5.3 数据备份建议

| 数据类型 | 备份频率 | 备份方式 |
|----------|----------|----------|
| production_status | 实时 | 主从复制 |
| zone_statistics | 实时 | 主从复制 |
| alert_records | 每日 | mysqldump |
| sensor_data | 每周 | 归档压缩 |

---

## 6. 初始化脚本

### 6.1 完整建库脚本

```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS production_monitor 
CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;

USE production_monitor;

-- 创建所有表（见第2节）

-- 插入默认设备状态
INSERT INTO production_status (device_id, status, mode, production_count) 
VALUES ('device_001', 'stopped', 'product_a', 0)
ON DUPLICATE KEY UPDATE device_id = device_id;

-- 插入默认危险区域统计
INSERT INTO zone_statistics (device_id, total_entries, total_exits, current_in_danger) 
VALUES ('device_001', 0, 0, 0)
ON DUPLICATE KEY UPDATE device_id = device_id;
```

### 6.2 执行方式

```bash
# 方式1：命令行执行
mysql -u root -p < backend/init_db.sql

# 方式2：应用启动时自动初始化
# FastAPI 启动时调用 init_db() 函数
```

---

## 附录

### A. 数据量估算

假设单设备运行场景：

| 数据类型 | 频率 | 每日数据量 | 7天数据量 |
|----------|------|-----------|----------|
| 传感器数据 | 3秒/条×3类型 | 86,400条 | 604,800条 |
| 检测记录 | 按需 | ~1,000条 | ~7,000条 |
| 报警记录 | 按需 | ~100条 | ~700条 |
| 危险区域事件 | 按需 | ~50条 | ~350条 |

### B. 性能优化建议

1. **分区表**：对于大数据量场景，可对 `sensor_data` 按时间分区
2. **读写分离**：高并发场景可配置主从复制
3. **连接池**：SQLAlchemy 默认启用连接池
4. **批量插入**：传感器数据可考虑批量插入优化

### C. 文档更新记录

| 版本 | 日期 | 更新内容 |
|------|------|---------|
| v1.0 | 2024-11 | 初始版本 |
| v2.0 | 2024-12 | 增加危险区域统计表和事件记录表 |
