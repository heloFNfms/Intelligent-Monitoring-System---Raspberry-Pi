# 智能生产线监控系统 - 系统运行流程

> 版本：v2.0  
> 更新日期：2024年12月  
> 文档状态：正式发布

---

## 1. 系统启动流程

### 1.1 整体启动顺序

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           系统启动顺序图                                     │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌──────────┐      ┌──────────┐      ┌──────────┐      ┌──────────┐
    │ 1.数据库  │ ───► │ 2.后端   │ ───► │ 3.前端   │ ───► │ 4.设备端  │
    │  MySQL   │      │ FastAPI  │      │  Vue 3   │      │ 树莓派/  │
    │          │      │          │      │          │      │ 模拟器   │
    └──────────┘      └──────────┘      └──────────┘      └──────────┘
         │                 │                 │                 │
         │                 │                 │                 │
         ▼                 ▼                 ▼                 ▼
    ┌──────────┐      ┌──────────┐      ┌──────────┐      ┌──────────┐
    │ 表结构   │      │ 初始化   │      │ WebSocket│      │ 连接后端 │
    │ 初始化   │      │ 后台任务 │      │ 连接     │      │ 开始上报 │
    └──────────┘      └──────────┘      └──────────┘      └──────────┘
```

**启动依赖关系**：
1. **MySQL 数据库** - 必须首先启动，后端依赖数据库连接
2. **FastAPI 后端** - 依赖数据库，为前端和设备端提供服务
3. **Vue 前端** - 依赖后端 API 和 WebSocket
4. **设备端** - 依赖后端 API 进行数据上报

---

### 1.2 后端服务启动流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        后端启动流程 (FastAPI)                                │
└─────────────────────────────────────────────────────────────────────────────┘

python run.py
      │
      ▼
┌─────────────────┐
│ Uvicorn 启动    │
│ host: 0.0.0.0   │
│ port: 8000      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ FastAPI 应用    │
│ 加载中间件      │
│ (CORS配置)      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ @app.on_event   │
│ ("startup")     │
│ 启动事件触发    │
└────────┬────────┘
         │
         ├──────────────────────────────────────────────────────────┐
         │                                                          │
         ▼                                                          ▼
┌─────────────────┐                                        ┌─────────────────┐
│ 1. init_db()    │                                        │ 2. 初始化默认   │
│ 数据库表初始化  │                                        │    设备传送带   │
│ SQLAlchemy ORM  │                                        │ device_001      │
└─────────────────┘                                        └─────────────────┘
         │                                                          │
         ├──────────────────────────────────────────────────────────┤
         │                                                          │
         ▼                                                          ▼
┌─────────────────┐                                        ┌─────────────────┐
│ 3. 启动自动     │                                        │ 4. 启动传送带   │
│    清理任务     │                                        │    模拟任务     │
│ 每6小时执行     │                                        │ 20 FPS 更新     │
└─────────────────┘                                        └─────────────────┘
         │                                                          │
         └──────────────────────────┬───────────────────────────────┘
                                    │
                                    ▼
                           ┌─────────────────┐
                           │ 5. 初始化调度   │
                           │    管理器       │
                           │ 加载默认规则    │
                           └─────────────────┘
                                    │
                                    ▼
                           ┌─────────────────┐
                           │ 🚀 服务就绪     │
                           │ 等待连接...     │
                           └─────────────────┘
```

**启动时初始化的后台任务**：

| 任务名称 | 执行间隔 | 功能描述 |
|---------|---------|---------|
| auto_cleanup_task | 6小时 | 清理7天前的过期数据 |
| conveyor_simulation_task | 50ms (20FPS) | 更新传送带状态并广播 |

**启动日志示例**：
```
✓ 数据库表初始化完成
📦 传送带已同步: 状态=stopped, 模式=product_a
🚀 智能生产线监控系统已启动
📋 自动调度规则已启用
🧹 数据保留 7 天，每 6 小时自动清理
🔄 传送带模拟已启动，更新频率: 20 FPS
```

---

### 1.3 前端启动流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         前端启动流程 (Vue 3)                                 │
└─────────────────────────────────────────────────────────────────────────────┘

npm run dev
      │
      ▼
┌─────────────────┐
│ Vite 开发服务器 │
│ port: 3000      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 加载 main.js    │
│ 创建 Vue 应用   │
│ 挂载 Element+   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ App.vue 挂载    │
│ onMounted()     │
└────────┬────────┘
         │
         ├─────────────────────────────────────────────────────────────┐
         │                                                             │
         ▼                                                             ▼
┌─────────────────┐                                           ┌─────────────────┐
│ 1. 建立         │                                           │ 2. 获取初始     │
│    WebSocket    │                                           │    数据         │
│    连接         │                                           │                 │
└────────┬────────┘                                           └────────┬────────┘
         │                                                             │
         ▼                                                             ▼
┌─────────────────┐                                           ┌─────────────────┐
│ ws://host:8000  │                                           │ GET /api/       │
│ /ws/dashboard   │                                           │ dashboard       │
│                 │                                           │ 仪表盘数据      │
└─────────────────┘                                           └─────────────────┘
         │                                                             │
         │                                                             ▼
         │                                                    ┌─────────────────┐
         │                                                    │ GET /api/       │
         │                                                    │ status/device   │
         │                                                    │ 生产状态        │
         │                                                    └─────────────────┘
         │                                                             │
         │                                                             ▼
         │                                                    ┌─────────────────┐
         │                                                    │ GET /api/       │
         │                                                    │ alerts          │
         │                                                    │ 报警列表        │
         │                                                    └─────────────────┘
         │                                                             │
         └─────────────────────────┬───────────────────────────────────┘
                                   │
                                   ▼
                          ┌─────────────────┐
                          │ 🖥️ 界面就绪     │
                          │ 开始接收实时    │
                          │ 数据推送        │
                          └─────────────────┘
```

---

### 1.4 设备端启动流程

#### 1.4.1 真实设备（树莓派）启动

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      树莓派设备启动流程                                      │
└─────────────────────────────────────────────────────────────────────────────┘

python unified_detection.py
      │
      ▼
┌─────────────────┐
│ 系统环境检测    │
│ • Windows/Linux │
│ • picamera2     │
│ • DHT11 传感器  │
└────────┬────────┘
         │
         ├─────────────────────────────────────────────────────────────┐
         │                                                             │
         ▼                                                             ▼
┌─────────────────┐                                           ┌─────────────────┐
│ 1. 加载 YOLOv8  │                                           │ 2. 初始化       │
│    检测模型     │                                           │    GPIO 控制    │
│ yolov8n_ncnn    │                                           │ LED + 蜂鸣器   │
└────────┬────────┘                                           └────────┬────────┘
         │                                                             │
         ▼                                                             ▼
┌─────────────────┐                                           ┌─────────────────┐
│ 3. 初始化       │                                           │ 4. 初始化       │
│    摄像头       │                                           │    DHT11 传感器 │
│ CSI/USB Camera  │                                           │ 温湿度采集      │
└────────┬────────┘                                           └────────┬────────┘
         │                                                             │
         └─────────────────────────┬───────────────────────────────────┘
                                   │
                                   ▼
                          ┌─────────────────┐
                          │ 5. 配置危险区域 │
                          │ 屏幕右半部分    │
                          │ 为危险区        │
                          └────────┬────────┘
                                   │
                                   ▼
                          ┌─────────────────┐
                          │ 6. 初始化       │
                          │    服务器客户端 │
                          │ ServerClient    │
                          └────────┬────────┘
                                   │
                                   ▼
                          ┌─────────────────┐
                          │ 🎥 开始检测循环 │
                          │ 实时视频分析    │
                          │ 数据上报        │
                          └─────────────────┘
```

#### 1.4.2 模拟器启动

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         模拟器启动流程                                       │
└─────────────────────────────────────────────────────────────────────────────┘

python simulator/main.py
      │
      ▼
┌─────────────────┐
│ 初始化模块      │
│ • SensorSimulator│
│ • DeviceClient  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 启动异步任务    │
└────────┬────────┘
         │
         ├─────────────────────────────────────────────────────────────┐
         │                                                             │
         ▼                                                             ▼
┌─────────────────┐                                           ┌─────────────────┐
│ _sensor_loop    │                                           │ _status_loop    │
│ 传感器数据      │                                           │ 状态同步        │
│ 上报循环        │                                           │ 循环            │
│ 间隔: 3秒       │                                           │ 间隔: 2秒       │
└─────────────────┘                                           └─────────────────┘
         │                                                             │
         └─────────────────────────┬───────────────────────────────────┘
                                   │
                                   ▼
                          ┌─────────────────┐
                          │ 🤖 模拟器运行中 │
                          │ 模拟传感器数据  │
                          └─────────────────┘
```



---

## 2. 核心业务流程

### 2.1 传感器数据采集与上报流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        传感器数据流程                                        │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────────┐
│   设备端/模拟器   │
│  (每3秒执行一次)  │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 读取传感器数据   │
│ • 温度 (DHT11)   │
│ • 湿度 (DHT11)   │
│ • 压力 (模拟)    │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐     HTTP POST        ┌──────────────────┐
│ DeviceClient     │ ──────────────────►  │ POST /api/sensor │
│ report_sensor()  │   {device_id,        │                  │
│                  │    sensor_type,      │                  │
│                  │    value, unit}      │                  │
└──────────────────┘                      └────────┬─────────┘
                                                   │
                                                   ▼
                                          ┌──────────────────┐
                                          │ 1. 存储到数据库  │
                                          │    sensor_data   │
                                          └────────┬─────────┘
                                                   │
                                                   ▼
                                          ┌──────────────────┐
                                          │ 2. WebSocket     │
                                          │    广播到前端    │
                                          │ type:sensor_     │
                                          │      update      │
                                          └────────┬─────────┘
                                                   │
                    ┌──────────────────────────────┼──────────────────────────────┐
                    │                              │                              │
                    ▼                              ▼                              ▼
           ┌──────────────────┐         ┌──────────────────┐         ┌──────────────────┐
           │ 3. 温度阈值检查  │         │ 4. 调度规则检查  │         │ 5. 前端图表更新  │
           │                  │         │                  │         │                  │
           │ ≥95°C → 危险报警 │         │ check_           │         │ ECharts 实时    │
           │ ≥80°C → 警告通知 │         │ temperature()    │         │ 曲线更新        │
           └────────┬─────────┘         └────────┬─────────┘         └──────────────────┘
                    │                            │
                    ▼                            ▼
           ┌──────────────────┐         ┌──────────────────┐
           │ 记录报警         │         │ 触发自动调度     │
           │ alert_records    │         │ • 高温暂停       │
           │ 广播报警通知     │         │ • 温度恢复启动   │
           └──────────────────┘         └──────────────────┘
```

**温度阈值配置**：

| 阈值类型 | 温度值 | 触发动作 |
|---------|--------|---------|
| 警告阈值 | ≥80°C | 广播警告通知 |
| 危险阈值 | ≥95°C | 记录报警 + 自动暂停生产线 |
| 恢复阈值 | <80°C | 连续3次低于阈值后自动恢复 |

---

### 2.2 危险区域检测流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      危险区域检测流程 (YOLOv8)                               │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────────┐
│   摄像头帧输入   │
│  (持续运行)      │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐     否
│ 跳帧检测判断     │ ─────────────────────────────────────────┐
│ frame_count %    │                                          │
│ frame_skip == 0  │                                          │
└────────┬─────────┘                                          │
         │ 是                                                  │
         ▼                                                     │
┌──────────────────┐                                          │
│ 图像预处理       │                                          │
│ 640x480 → 320x320│                                          │
└────────┬─────────┘                                          │
         │                                                     │
         ▼                                                     │
┌──────────────────┐                                          │
│ YOLOv8 推理      │                                          │
│ 检测 person 类别 │                                          │
│ conf > 0.5       │                                          │
└────────┬─────────┘                                          │
         │                                                     │
         ▼                                                     │
┌──────────────────┐                                          │
│ 坐标还原         │                                          │
│ 缩放比例映射     │                                          │
└────────┬─────────┘                                          │
         │                                                     │
         ▼                                                     │
┌──────────────────┐                                          │
│ PersonTracker    │◄─────────────────────────────────────────┘
│ 人员追踪更新     │     (使用上次检测结果)
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 状态变化检测     │
│ SAFE ↔ DANGER    │
└────────┬─────────┘
         │
         ├─────────────────────────────────────────────────────────────┐
         │ 进入危险区 (enter)                                          │ 离开危险区 (exit)
         ▼                                                             ▼
┌──────────────────┐                                          ┌──────────────────┐
│ 1. 更新统计      │                                          │ 1. 更新统计      │
│    total_entries++│                                          │    total_exits++ │
│    current_in_   │                                          │    current_in_   │
│    danger++      │                                          │    danger--      │
└────────┬─────────┘                                          └────────┬─────────┘
         │                                                             │
         ▼                                                             ▼
┌──────────────────┐                                          ┌──────────────────┐
│ 2. 触发报警回调  │                                          │ 2. 触发离开回调  │
│    alert_callback│                                          │    exit_callback │
│    播放警报声    │                                          │    通知前端      │
│    点亮报警LED   │                                          │                  │
└────────┬─────────┘                                          └────────┬─────────┘
         │                                                             │
         └─────────────────────────┬───────────────────────────────────┘
                                   │
                                   ▼
                          ┌──────────────────┐
                          │ 3. 上报到后端    │
                          │ POST /api/zone/  │
                          │      event       │
                          └────────┬─────────┘
                                   │
                                   ▼
                          ┌──────────────────┐
                          │ 4. 后端处理      │
                          │ • 更新统计表     │
                          │ • 记录事件       │
                          │ • 记录报警       │
                          │ • WebSocket广播  │
                          └────────┬─────────┘
                                   │
                                   ▼
                          ┌──────────────────┐
                          │ 5. 前端响应      │
                          │ • 报警动画       │
                          │ • 统计更新       │
                          │ • 声音提示       │
                          └──────────────────┘
```

**危险区域配置**：

```python
# 默认配置：屏幕右半部分为危险区域
CAMERA_WIDTH = 640
CAMERA_HEIGHT = 480

# 危险区域（右半部分）
danger_zone = [
    (CAMERA_WIDTH // 2, 0),           # 左上
    (CAMERA_WIDTH, 0),                 # 右上
    (CAMERA_WIDTH, CAMERA_HEIGHT),     # 右下
    (CAMERA_WIDTH // 2, CAMERA_HEIGHT) # 左下
]

# 安全区域（左半部分）
safe_zone = [
    (0, 0),
    (CAMERA_WIDTH // 2, 0),
    (CAMERA_WIDTH // 2, CAMERA_HEIGHT),
    (0, CAMERA_HEIGHT)
]
```

---

### 2.3 生产控制流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         生产控制流程                                         │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────────┐
│   用户操作       │
│  (前端界面)      │
│ • 启动/停止/暂停 │
│ • 切换模式       │
│ • 重置计数       │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐     HTTP POST        ┌──────────────────┐
│ 发送控制指令     │ ──────────────────►  │ POST /api/control│
│ {device_id,      │                      │                  │
│  command,        │                      │                  │
│  params}         │                      │                  │
└──────────────────┘                      └────────┬─────────┘
                                                   │
                                                   ▼
                                          ┌──────────────────┐
                                          │ 1. 更新数据库    │
                                          │    production_   │
                                          │    status        │
                                          └────────┬─────────┘
                                                   │
                                                   ▼
                                          ┌──────────────────┐
                                          │ 2. 同步传送带    │
                                          │    状态          │
                                          │ conveyor.sync_   │
                                          │ with_production()│
                                          └────────┬─────────┘
                                                   │
                                                   ▼
                                          ┌──────────────────┐
                                          │ 3. WebSocket     │
                                          │    广播状态变更  │
                                          │ type:status_     │
                                          │      change      │
                                          └────────┬─────────┘
                                                   │
                                                   ▼
                                          ┌──────────────────┐
                                          │ 4. 广播传送带    │
                                          │    状态          │
                                          │ type:conveyor_   │
                                          │      update      │
                                          └────────┬─────────┘
                                                   │
                                                   ▼
                                          ┌──────────────────┐
                                          │ 5. 推送到设备端  │
                                          │    (可选)        │
                                          │ WebSocket 推送   │
                                          └──────────────────┘
```

**支持的控制指令**：

| 指令 | 参数 | 功能描述 | 状态变化 |
|------|------|---------|---------|
| start | - | 启动生产线 | stopped/paused → running |
| stop | - | 停止生产线 | * → stopped |
| pause | - | 暂停生产线 | running → paused |
| switch_mode | {mode: "product_b"} | 切换生产模式 | 模式变更 |
| reset_count | - | 重置生产计数 | production_count = 0 |



---

### 2.4 传送带运行流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        传送带模拟运行流程                                    │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────────┐
│ 后台任务启动     │
│ conveyor_        │
│ simulation_task  │
│ (20 FPS)         │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 每帧循环执行     │
│ (每50ms一次)     │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 遍历所有设备的   │
│ 传送带管理器     │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐     否
│ 传送带运行中?    │ ─────────────────────────────────────────┐
│ is_running       │                                          │
└────────┬─────────┘                                          │
         │ 是                                                  │
         ▼                                                     │
┌──────────────────┐                                          │
│ 1. 自动生成物品  │                                          │
│ (检查生成间隔)   │                                          │
│ interval/speed   │                                          │
└────────┬─────────┘                                          │
         │                                                     │
         ▼                                                     │
┌──────────────────┐                                          │
│ 2. 更新物品位置  │                                          │
│ position +=      │                                          │
│ 12 * speed *     │                                          │
│ delta_time       │                                          │
└────────┬─────────┘                                          │
         │                                                     │
         ▼                                                     │
┌──────────────────┐     否                                   │
│ 有物品到达终点?  │ ─────────────────────────────────────────┤
│ position >= 100  │                                          │
└────────┬─────────┘                                          │
         │ 是                                                  │
         ▼                                                     │
┌──────────────────┐                                          │
│ 3. 移除完成物品  │                                          │
│ completed_count++│                                          │
└────────┬─────────┘                                          │
         │                                                     │
         ▼                                                     │
┌──────────────────┐                                          │
│ 4. 同步生产计数  │                                          │
│ 更新数据库       │                                          │
│ production_count │                                          │
└────────┬─────────┘                                          │
         │                                                     │
         ▼                                                     │
┌──────────────────┐                                          │
│ 5. 检查调度规则  │                                          │
│ check_production │                                          │
│ (产量目标检查)   │                                          │
└────────┬─────────┘                                          │
         │                                                     │
         └─────────────────────────┬───────────────────────────┘
                                   │
                                   ▼
                          ┌──────────────────┐
                          │ 6. WebSocket     │
                          │    广播状态      │
                          │ type:conveyor_   │
                          │      update      │
                          └────────┬─────────┘
                                   │
                                   ▼
                          ┌──────────────────┐
                          │ 前端传送带动画   │
                          │ 实时更新         │
                          └──────────────────┘
```

**传送带物品生命周期**：

```
生成条件检查 ──► 创建物品 ──► 位置更新 ──► 到达终点 ──► 计数+1
     │              │            │            │
     │              │            │            │
     ▼              ▼            ▼            ▼
• 物品数<8      • 分配ID     • 每帧移动   • 移除物品
• 入口无物品    • 设置类型   • 12%/秒     • 更新统计
• 间隔已到      • 设置颜色   • ×速度倍率  • 广播状态
```

**产品类型配置**：

| 产品类型 | 颜色代码 | 形状 | 显示名称 |
|---------|---------|------|---------|
| product_a | #3a91c7 | box (方形) | 产品A |
| product_b | #2db7b5 | cylinder (圆柱) | 产品B |

---

### 2.5 自动调度流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         自动调度流程                                         │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌──────────────────┐
                    │   触发源         │
                    └────────┬─────────┘
                             │
          ┌──────────────────┼──────────────────┐
          │                  │                  │
          ▼                  ▼                  ▼
┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐
│ 温度数据上报     │ │ 产量更新         │ │ 定时任务         │
│ (传感器)         │ │ (传送带完成)     │ │ (未来扩展)       │
└────────┬─────────┘ └────────┬─────────┘ └──────────────────┘
         │                    │
         ▼                    ▼
┌──────────────────┐ ┌──────────────────┐
│ check_           │ │ check_           │
│ temperature()    │ │ production()     │
└────────┬─────────┘ └────────┬─────────┘
         │                    │
         └────────────────────┼────────────────────┐
                              │                    │
                              ▼                    │
                     ┌──────────────────┐          │
                     │ 遍历启用的规则   │          │
                     └────────┬─────────┘          │
                              │                    │
                              ▼                    │
                     ┌──────────────────┐    否    │
                     │ 检查冷却时间     │ ─────────┤
                     │ current_time -   │          │
                     │ last_triggered   │          │
                     │ > cooldown       │          │
                     └────────┬─────────┘          │
                              │ 是                 │
                              ▼                    │
                     ┌──────────────────┐    否    │
                     │ 检查触发条件     │ ─────────┤
                     │ value > threshold│          │
                     │ 或其他条件       │          │
                     └────────┬─────────┘          │
                              │ 是                 │
                              ▼                    │
                     ┌──────────────────┐          │
                     │ 执行调度动作     │          │
                     │ execute_schedule │          │
                     │ _action()        │          │
                     └────────┬─────────┘          │
                              │                    │
          ┌───────────────────┼───────────────────┐│
          │                   │                   ││
          ▼                   ▼                   ▼│
┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐
│ 更新数据库状态   │ │ 同步传送带       │ │ WebSocket 广播   │
│ production_      │ │ conveyor.sync_   │ │ • status_change  │
│ status           │ │ with_production()│ │ • schedule_action│
└──────────────────┘ └──────────────────┘ └──────────────────┘
```

**默认调度规则**：

| 规则ID | 名称 | 触发条件 | 动作 | 冷却时间 |
|--------|------|---------|------|---------|
| temp_danger_pause | 高温自动暂停 | 温度 > 95°C | pause | 30秒 |
| temp_recover_start | 温度恢复启动 | 温度 < 80°C (连续3次) | start | 30秒 |
| production_complete | 产量达标停止 | 产量 ≥ 目标 | stop/switch_mode | 5秒 |

**温度恢复启动的特殊逻辑**：

```python
# 只有因高温暂停的才能自动恢复
if self.paused_by_temp.get(device_id, False):
    # 检查最近3次温度是否都低于阈值
    recent_temps = self.temp_history.get(device_id, [])
    if len(recent_temps) >= 3:
        if all(t < threshold for t in recent_temps[-3:]):
            # 触发恢复启动
            triggered = True
            self.paused_by_temp[device_id] = False
```



---

## 3. 实时通信流程

### 3.1 WebSocket 连接管理

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      WebSocket 连接管理流程                                  │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│                         ConnectionManager                                    │
│                                                                              │
│  ┌─────────────────────────────┐    ┌─────────────────────────────┐        │
│  │   dashboard_connections     │    │    device_connections       │        │
│  │   List[WebSocket]           │    │    Dict[device_id, WS]      │        │
│  │                             │    │                             │        │
│  │   前端大屏连接池            │    │   设备端连接映射            │        │
│  │   支持多个客户端同时连接    │    │   按设备ID索引              │        │
│  └─────────────────────────────┘    └─────────────────────────────┘        │
│                                                                              │
│  广播方法:                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ broadcast_sensor_update()    → 传感器数据更新                       │   │
│  │ broadcast_detection()        → 检测结果推送                         │   │
│  │ broadcast_alert()            → 报警信息推送                         │   │
│  │ broadcast_status_change()    → 生产状态变更                         │   │
│  │ broadcast_conveyor_update()  → 传送带状态更新                       │   │
│  │ broadcast_zone_event()       → 危险区域事件                         │   │
│  │ broadcast_led_status()       → LED状态变化                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 前端 WebSocket 连接流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     前端 WebSocket 连接流程                                  │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────────┐
│ 前端应用启动     │
│ App.vue mounted  │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 创建 WebSocket   │
│ ws://host:8000   │
│ /ws/dashboard    │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 后端接受连接     │
│ connect_         │
│ dashboard()      │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 加入连接池       │
│ dashboard_       │
│ connections.     │
│ append(ws)       │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 开始接收消息     │
│ ws.onmessage     │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 消息分发处理     │
│ switch(type)     │
└────────┬─────────┘
         │
         ├─────────────────────────────────────────────────────────────┐
         │                                                             │
         ▼                                                             ▼
┌──────────────────┐                                          ┌──────────────────┐
│ sensor_update    │                                          │ conveyor_update  │
│ 更新传感器图表   │                                          │ 更新传送带动画   │
└──────────────────┘                                          └──────────────────┘
         │                                                             │
         ├─────────────────────────────────────────────────────────────┤
         │                                                             │
         ▼                                                             ▼
┌──────────────────┐                                          ┌──────────────────┐
│ alert            │                                          │ status_change    │
│ 显示报警通知     │                                          │ 更新状态显示     │
│ 播放报警动画     │                                          │ 同步控制按钮     │
└──────────────────┘                                          └──────────────────┘
         │                                                             │
         ├─────────────────────────────────────────────────────────────┤
         │                                                             │
         ▼                                                             ▼
┌──────────────────┐                                          ┌──────────────────┐
│ video_frame      │                                          │ zone_event       │
│ 更新视频画面     │                                          │ 更新区域统计     │
│ 叠加检测结果     │                                          │ 显示事件通知     │
└──────────────────┘                                          └──────────────────┘
```

### 3.3 WebSocket 消息格式

**统一消息结构**：

```json
{
  "type": "消息类型",
  "data": {
    "device_id": "设备ID",
    // ... 具体数据字段
  },
  "timestamp": "2024-12-14T10:30:00.000000"
}
```

**消息类型一览**：

| type | 方向 | 描述 | data 主要字段 |
|------|------|------|--------------|
| sensor_update | 后端→前端 | 传感器数据 | sensor_type, value, unit |
| detection | 后端→前端 | 检测结果 | person_count, in_danger_zone |
| alert | 后端→前端 | 报警通知 | alert_type, message, level |
| status_change | 后端→前端 | 状态变更 | status, mode, production_count |
| conveyor_update | 后端→前端 | 传送带更新 | is_running, items, speed |
| zone_event | 后端→前端 | 区域事件 | event_type, statistics |
| video_frame | 后端→前端 | 视频帧 | frame (Base64), detection |
| led_status | 后端→前端 | LED状态 | led_type, state |
| schedule_action | 后端→前端 | 调度动作 | action, reason, message |
| product_detection | 后端→前端 | 产品检测 | product_type, color, shape |
| control | 前端→后端 | 控制指令 | command, params |

---

## 4. 报警处理流程

### 4.1 报警触发与处理

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         报警处理流程                                         │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌──────────────────┐
                    │   报警触发源     │
                    └────────┬─────────┘
                             │
     ┌───────────────────────┼───────────────────────┐
     │                       │                       │
     ▼                       ▼                       ▼
┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐
│ 温度异常         │ │ 人员入侵         │ │ 危险区域事件     │
│ temperature      │ │ intrusion        │ │ zone_enter/exit  │
│ ≥95°C 危险       │ │ alert_triggered  │ │ 进入/离开        │
│ ≥80°C 警告       │ │ = true           │ │ 危险区域         │
└────────┬─────────┘ └────────┬─────────┘ └────────┬─────────┘
         │                    │                    │
         └────────────────────┼────────────────────┘
                              │
                              ▼
                     ┌──────────────────┐
                     │ 创建报警记录     │
                     │ AlertRecord      │
                     │ • device_id      │
                     │ • alert_type     │
                     │ • message        │
                     │ • level          │
                     │ • resolved=False │
                     └────────┬─────────┘
                              │
                              ▼
                     ┌──────────────────┐
                     │ 存储到数据库     │
                     │ alert_records    │
                     └────────┬─────────┘
                              │
                              ▼
                     ┌──────────────────┐
                     │ WebSocket 广播   │
                     │ broadcast_alert()│
                     │ type: alert      │
                     └────────┬─────────┘
                              │
                              ▼
                     ┌──────────────────┐
                     │ 前端接收处理     │
                     └────────┬─────────┘
                              │
          ┌───────────────────┼───────────────────┐
          │                   │                   │
          ▼                   ▼                   ▼
┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐
│ 显示通知         │ │ 报警动画         │ │ 更新报警列表     │
│ Element Plus     │ │ 全屏闪烁         │ │ 未处理报警数     │
│ Notification     │ │ (danger级别)     │ │ +1               │
└──────────────────┘ └──────────────────┘ └──────────────────┘
```

### 4.2 报警级别与响应

| 级别 | 颜色 | 触发场景 | 前端响应 |
|------|------|---------|---------|
| info | 蓝色 | 人员离开危险区 | 普通通知 |
| warning | 橙色 | 温度 ≥80°C | 警告通知 |
| danger | 红色 | 温度 ≥95°C、人员入侵、进入危险区 | 全屏报警动画 + 声音 |

### 4.3 设备端报警响应

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      设备端报警响应流程 (树莓派)                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────────┐
│ 检测到危险       │
│ (人员进入危险区) │
└────────┬─────────┘
         │
         ├─────────────────────────────────────────────────────────────┐
         │                                                             │
         ▼                                                             ▼
┌──────────────────┐                                          ┌──────────────────┐
│ 播放报警声音     │                                          │ 控制 GPIO        │
│                  │                                          │                  │
│ Windows:         │                                          │ LED 报警灯:      │
│ winsound.Beep()  │                                          │ GPIO.output(     │
│                  │                                          │   led_pin, HIGH) │
│ Linux:           │                                          │                  │
│ aplay 或蜂鸣器   │                                          │ 蜂鸣器:          │
│                  │                                          │ GPIO.output(     │
│                  │                                          │   buzzer_pin,    │
│                  │                                          │   HIGH)          │
└──────────────────┘                                          └────────┬─────────┘
                                                                       │
                                                                       ▼
                                                              ┌──────────────────┐
                                                              │ 3秒后自动关闭    │
                                                              │ LED 和蜂鸣器     │
                                                              └──────────────────┘
```



---

## 5. 视频流处理流程

### 5.1 视频帧采集与推送

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        视频流处理流程                                        │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────────┐
│ 摄像头帧捕获     │
│ (持续运行)       │
│ 640x480          │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ YOLOv8 检测      │
│ 叠加检测结果     │
│ • 边界框         │
│ • 区域标注       │
│ • 统计信息       │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐     否
│ 帧率控制检查     │ ─────────────────────────────────────────┐
│ current_time -   │                                          │
│ last_stream_time │                                          │
│ >= 1/10 (10FPS)  │                                          │
└────────┬─────────┘                                          │
         │ 是                                                  │
         ▼                                                     │
┌──────────────────┐                                          │
│ JPEG 压缩        │                                          │
│ quality: 50%     │                                          │
└────────┬─────────┘                                          │
         │                                                     │
         ▼                                                     │
┌──────────────────┐                                          │
│ Base64 编码      │                                          │
└────────┬─────────┘                                          │
         │                                                     │
         ▼                                                     │
┌──────────────────┐     HTTP POST        ┌──────────────────┐│
│ 异步上报         │ ──────────────────►  │ POST /api/video/ ││
│ (独立线程)       │   {device_id,        │ frame            ││
│                  │    frame,            │                  ││
│                  │    detection,        │                  ││
│                  │    timestamp}        │                  ││
└──────────────────┘                      └────────┬─────────┘│
                                                   │          │
                                                   ▼          │
                                          ┌──────────────────┐│
                                          │ 缓存最新帧       ││
                                          │ latest_video_    ││
                                          │ frames[device_id]││
                                          └────────┬─────────┘│
                                                   │          │
                                                   ▼          │
                                          ┌──────────────────┐│
                                          │ WebSocket 广播   ││
                                          │ type: video_frame││
                                          └────────┬─────────┘│
                                                   │          │
                                                   └──────────┤
                                                              │
                                                              ▼
                                                     ┌──────────────────┐
                                                     │ 前端渲染         │
                                                     │ <img :src=       │
                                                     │ "data:image/     │
                                                     │ jpeg;base64,...">│
                                                     └──────────────────┘
```

**视频流配置参数**：

| 参数 | 值 | 说明 |
|------|-----|------|
| VIDEO_STREAM_FPS | 10 | 视频流帧率 |
| VIDEO_QUALITY | 50 | JPEG压缩质量 (1-100) |
| CAMERA_WIDTH | 640 | 摄像头宽度 |
| CAMERA_HEIGHT | 480 | 摄像头高度 |

---

## 6. 数据管理流程

### 6.1 数据存储流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         数据存储流程                                         │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌──────────────────┐
                    │   数据来源       │
                    └────────┬─────────┘
                             │
     ┌───────────────────────┼───────────────────────┐
     │                       │                       │
     ▼                       ▼                       ▼
┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐
│ 传感器数据       │ │ 检测数据         │ │ 报警数据         │
│ POST /api/sensor │ │ POST /api/       │ │ 自动生成         │
│                  │ │ detection        │ │                  │
└────────┬─────────┘ └────────┬─────────┘ └────────┬─────────┘
         │                    │                    │
         ▼                    ▼                    ▼
┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐
│ sensor_data      │ │ detection_       │ │ alert_records    │
│ 表               │ │ records 表       │ │ 表               │
│                  │ │                  │ │                  │
│ • device_id      │ │ • device_id      │ │ • device_id      │
│ • sensor_type    │ │ • person_count   │ │ • alert_type     │
│ • value          │ │ • in_danger_zone │ │ • message        │
│ • unit           │ │ • alert_triggered│ │ • level          │
│ • timestamp      │ │ • timestamp      │ │ • resolved       │
└──────────────────┘ └──────────────────┘ └──────────────────┘
         │                    │                    │
         └────────────────────┼────────────────────┘
                              │
                              ▼
                     ┌──────────────────┐
                     │ 数据量估算       │
                     │ (单设备/天)      │
                     │                  │
                     │ 传感器: ~86,400条│
                     │ 检测: ~1,000条   │
                     │ 报警: ~100条     │
                     └──────────────────┘
```

### 6.2 自动数据清理流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       自动数据清理流程                                       │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────────┐
│ 后台清理任务     │
│ auto_cleanup_    │
│ task             │
│ (每6小时执行)    │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 计算截止日期     │
│ cutoff_date =    │
│ now() - 7 days   │
└────────┬─────────┘
         │
         ├─────────────────────────────────────────────────────────────┐
         │                                                             │
         ▼                                                             ▼
┌──────────────────┐                                          ┌──────────────────┐
│ 清理 sensor_data │                                          │ 清理 detection_  │
│ WHERE timestamp  │                                          │ records          │
│ < cutoff_date    │                                          │ WHERE timestamp  │
│                  │                                          │ < cutoff_date    │
└────────┬─────────┘                                          └────────┬─────────┘
         │                                                             │
         └─────────────────────────┬───────────────────────────────────┘
                                   │
                                   ▼
                          ┌──────────────────┐
                          │ 清理 alert_      │
                          │ records          │
                          │ WHERE timestamp  │
                          │ < cutoff_date    │
                          │ AND resolved =   │
                          │ TRUE             │
                          └────────┬─────────┘
                                   │
                                   ▼
                          ┌──────────────────┐
                          │ 提交事务         │
                          │ db.commit()      │
                          └────────┬─────────┘
                                   │
                                   ▼
                          ┌──────────────────┐
                          │ 输出清理日志     │
                          │ "🧹 自动清理完成 │
                          │ 删除 N 条数据"   │
                          └──────────────────┘
```

**数据保留策略**：

| 数据类型 | 保留时间 | 清理条件 |
|---------|---------|---------|
| sensor_data | 7天 | timestamp < 7天前 |
| detection_records | 7天 | timestamp < 7天前 |
| alert_records | 7天 | timestamp < 7天前 且 resolved = true |
| zone_event_records | 可配置 | 手动清理 |
| production_status | 永久 | 不清理 |
| zone_statistics | 永久 | 手动重置 |



---

## 7. 完整运行示例

### 7.1 开发环境启动步骤

```bash
# ==================== 步骤1: 启动数据库 ====================
# 确保 MySQL 服务已启动
# Windows: 服务管理器启动 MySQL
# Linux: sudo systemctl start mysql

# 初始化数据库（首次运行）
mysql -u root -p < backend/init_db.sql


# ==================== 步骤2: 启动后端服务 ====================
cd backend

# 安装依赖（首次运行）
pip install -r requirements.txt

# 启动服务
python run.py

# 预期输出:
# ✓ 数据库表初始化完成
# 📦 传送带已同步: 状态=stopped, 模式=product_a
# 🚀 智能生产线监控系统已启动
# 📋 自动调度规则已启用
# 🧹 数据保留 7 天，每 6 小时自动清理
# 🔄 传送带模拟已启动，更新频率: 20 FPS
# INFO:     Uvicorn running on http://0.0.0.0:8000


# ==================== 步骤3: 启动前端服务 ====================
cd frontend

# 安装依赖（首次运行）
npm install

# 启动开发服务器
npm run dev

# 预期输出:
# VITE v5.x.x  ready in xxx ms
# ➜  Local:   http://localhost:3000/


# ==================== 步骤4: 启动模拟器（可选） ====================
cd simulator

# 安装依赖（首次运行）
pip install -r requirements.txt

# 启动模拟器
python main.py

# 预期输出:
# ============================================================
# 🤖 智能生产线模拟器
# ============================================================
# 📡 服务器地址: http://localhost:8000
# 🔧 设备ID: device_001
# ⏱️  传感器上报间隔: 3秒
# 📌 功能：传感器数据模拟（传送带由后端管理）
```

### 7.2 生产环境部署步骤

```bash
# ==================== 服务器端部署 ====================

# 1. 配置 MySQL 数据库
mysql -u root -p
CREATE DATABASE production_monitor CHARACTER SET utf8mb4;
USE production_monitor;
SOURCE /path/to/backend/init_db.sql;

# 2. 配置后端服务
cd backend
pip install -r requirements.txt

# 修改配置（backend/app/config.py）
# DATABASE_URL = "mysql+pymysql://user:pass@localhost/production_monitor"

# 使用 Gunicorn 或 Uvicorn 生产模式启动
uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 4

# 3. 构建前端
cd frontend
npm install
npm run build

# 4. 配置 Nginx
# 将 dist 目录配置为静态资源
# 配置 /api 和 /ws 反向代理到后端


# ==================== 树莓派端部署 ====================

# 1. 安装依赖
cd project
pip install -r requirements.txt

# 2. 修改服务器地址
# 编辑 unified_detection.py
# SERVER_URL = "http://服务器IP:8000"

# 3. 启动检测程序
python unified_detection.py

# 或使用 systemd 配置开机自启
```

### 7.3 典型运行场景

#### 场景1: 正常生产流程

```
时间线:
────────────────────────────────────────────────────────────────────────────────

T+0s    用户点击"启动"按钮
        │
        ├─► POST /api/control {command: "start"}
        ├─► 数据库更新: status = "running"
        ├─► 传送带启动: is_running = true
        └─► WebSocket 广播: status_change

T+2.5s  传送带生成第一个物品
        │
        ├─► 物品 ID=1, position=0, type=product_a
        └─► WebSocket 广播: conveyor_update

T+3s    传感器数据上报
        │
        ├─► POST /api/sensor {temperature: 65.5}
        ├─► 数据库存储
        └─► WebSocket 广播: sensor_update

T+10s   物品到达终点
        │
        ├─► completed_count++
        ├─► production_count++
        ├─► 数据库更新
        └─► WebSocket 广播: status_change

...     循环继续
```

#### 场景2: 危险区域入侵报警

```
时间线:
────────────────────────────────────────────────────────────────────────────────

T+0s    YOLOv8 检测到人员
        │
        └─► person_count = 1, 位置在安全区

T+1s    人员移动到危险区域
        │
        ├─► PersonTracker 检测状态变化: SAFE → DANGER
        ├─► ZoneStatistics 更新: total_entries++, current_in_danger++
        ├─► 触发 alert_callback
        │   ├─► 播放报警声音
        │   └─► 点亮报警 LED
        └─► POST /api/zone/event {event_type: "enter"}

T+1.1s  后端处理
        │
        ├─► 更新 zone_statistics 表
        ├─► 记录 zone_event_records
        ├─► 创建 alert_records (level: danger)
        └─► WebSocket 广播: zone_event, alert

T+1.2s  前端响应
        │
        ├─► 显示报警通知
        ├─► 播放全屏报警动画
        ├─► 更新危险区域统计
        └─► 报警列表 +1

T+5s    人员离开危险区域
        │
        ├─► PersonTracker 检测状态变化: DANGER → SAFE
        ├─► ZoneStatistics 更新: total_exits++, current_in_danger--
        └─► POST /api/zone/event {event_type: "exit"}
```

#### 场景3: 高温自动调度

```
时间线:
────────────────────────────────────────────────────────────────────────────────

T+0s    生产线运行中, 温度正常 (65°C)

T+30s   温度上升到 80°C
        │
        ├─► POST /api/sensor {temperature: 80}
        ├─► 触发警告通知
        └─► WebSocket 广播: alert (level: warning)

T+60s   温度上升到 96°C
        │
        ├─► POST /api/sensor {temperature: 96}
        ├─► 调度规则检查: temp_danger_pause
        │   └─► 条件满足: 96 > 95
        ├─► 执行调度动作: pause
        │   ├─► 数据库更新: status = "paused"
        │   ├─► 传送带暂停: is_running = false
        │   └─► paused_by_temp[device_id] = true
        ├─► WebSocket 广播: status_change, schedule_action
        └─► 记录危险报警

T+90s   温度下降到 78°C (第1次)
        │
        └─► 记录到 temp_history

T+93s   温度下降到 76°C (第2次)
        │
        └─► 记录到 temp_history

T+96s   温度下降到 75°C (第3次)
        │
        ├─► 调度规则检查: temp_recover_start
        │   └─► 条件满足: 连续3次 < 80
        ├─► 执行调度动作: start
        │   ├─► 数据库更新: status = "running"
        │   ├─► 传送带启动: is_running = true
        │   └─► paused_by_temp[device_id] = false
        └─► WebSocket 广播: status_change, schedule_action
```

---

## 8. 故障处理流程

### 8.1 WebSocket 断线重连

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      WebSocket 断线重连流程                                  │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────────┐
│ WebSocket 连接   │
│ 正常运行         │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 检测到断开       │
│ onclose/onerror  │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 启动重连计时器   │
│ setTimeout       │
│ (3000ms)         │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐     失败
│ 尝试重新连接     │ ─────────────────────────────────────────┐
│ new WebSocket()  │                                          │
└────────┬─────────┘                                          │
         │ 成功                                                │
         ▼                                                     │
┌──────────────────┐                                          │
│ 重新获取初始数据 │                                          │
│ • GET /dashboard │                                          │
│ • GET /status    │                                          │
│ • GET /alerts    │                                          │
└────────┬─────────┘                                          │
         │                                                     │
         ▼                                                     │
┌──────────────────┐                                          │
│ 恢复正常运行     │◄─────────────────────────────────────────┘
│                  │     (重试，最多5次)
└──────────────────┘
```

### 8.2 设备端异常处理

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       设备端异常处理流程                                     │
└─────────────────────────────────────────────────────────────────────────────┘

异常类型              处理方式
────────────────────────────────────────────────────────────────────────────────

摄像头打开失败        → 打印错误信息，退出程序
                      → 检查摄像头连接和权限

帧读取失败            → 打印错误，尝试继续
                      → 连续失败则退出

服务器连接失败        → 异步上报，不阻塞主循环
                      → 本地继续检测和报警

GPIO 初始化失败       → 禁用 LED/蜂鸣器功能
                      → 其他功能正常运行

DHT11 读取失败        → 返回上次成功读取的值
                      → 偶尔失败是正常的

YOLOv8 推理异常       → 使用上次检测结果
                      → 跳帧机制保证流畅
```

---

## 附录

### A. 配置参数汇总

#### A.1 后端配置 (backend/app/config.py)

| 参数 | 默认值 | 说明 |
|------|--------|------|
| DATABASE_URL | mysql+pymysql://... | 数据库连接字符串 |
| TEMP_WARNING_THRESHOLD | 80 | 温度警告阈值 (°C) |
| TEMP_DANGER_THRESHOLD | 95 | 温度危险阈值 (°C) |
| DATA_RETENTION_DAYS | 7 | 数据保留天数 |
| AUTO_CLEANUP_INTERVAL | 21600 | 自动清理间隔 (秒) |
| CONVEYOR_UPDATE_INTERVAL | 0.05 | 传送带更新间隔 (秒) |

#### A.2 设备端配置 (project/unified_detection.py)

| 参数 | 默认值 | 说明 |
|------|--------|------|
| SERVER_URL | http://192.168.137.1:8000 | 后端服务器地址 |
| DEVICE_ID | device_001 | 设备唯一标识 |
| ENABLE_SERVER_REPORT | True | 是否启用数据上报 |
| ENABLE_VIDEO_STREAM | True | 是否启用视频流 |
| VIDEO_STREAM_FPS | 10 | 视频流帧率 |
| VIDEO_QUALITY | 50 | JPEG压缩质量 |
| CAMERA_WIDTH | 480 | 摄像头宽度 |
| CAMERA_HEIGHT | 360 | 摄像头高度 |

#### A.3 模拟器配置 (simulator/config.py)

| 参数 | 默认值 | 说明 |
|------|--------|------|
| SERVER_URL | http://localhost:8000 | 后端服务器地址 |
| DEVICE_ID | device_001 | 设备唯一标识 |
| SENSOR_INTERVAL | 3 | 传感器上报间隔 (秒) |
| STATUS_CHECK_INTERVAL | 2 | 状态检查间隔 (秒) |
| BASE_TEMPERATURE | 65 | 基础温度 (°C) |
| BASE_PRESSURE | 100 | 基础压力 (kPa) |
| BASE_HUMIDITY | 55 | 基础湿度 (%) |

### B. 端口规划

| 服务 | 端口 | 协议 | 说明 |
|------|------|------|------|
| FastAPI 后端 | 8000 | HTTP/WS | API 和 WebSocket |
| Vue 前端 (开发) | 3000 | HTTP | Vite 开发服务器 |
| MySQL | 3306 | TCP | 数据库服务 |

### C. 文档更新记录

| 版本 | 日期 | 更新内容 |
|------|------|---------|
| v1.0 | 2024-11 | 初始版本 |
| v2.0 | 2024-12 | 完善运行流程，增加调度、追踪、视频流等流程 |
